<!DOCTYPE html>

<html>
<head>
  <title> Lux</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="cms.html">
                cms.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="lorem.html">
                lorem.js
              </a>
            
              
              <a class="source" href="lux-web.html">
                lux-web.js
              </a>
            
              
              <a class="source" href="lux.html">
                lux.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="-lux"> Lux</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p> Javascript library for lux web-framework. It defines the following
 components:</p>
<ul>
<li><a href="#class">Class</a>: an object-oriented class construct. It provides inheritance
and overriding capabilities via the <code>_super</code> method.</li>
<li><a href="#model">Model</a>: extends <code>Class</code> with methods for handling back-end data.
A model is a representation of a data store item/row.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">'lodash'</span>, <span class="hljs-string">'jquery'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_, $)</span> {</span>
<span class="hljs-pi">    "use strict"</span>;

    <span class="hljs-keyword">var</span>

    root = window,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    prev_lux = root.lux,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    slice = <span class="hljs-built_in">Array</span>.prototype.slice;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux = root.lux = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        debug: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        skins: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Container of libraries used by lux</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        libraries: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        media_url: <span class="hljs-string">'/media/'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        icon: <span class="hljs-string">'fontawesome'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        data_api: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        set_value_hooks: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Set the <code>value</code> for <code>elem</code></p>
<p> This is generalised value setting method which tries
 the <code>set_value_hooks</code> functions first, and if none of them
 return <code>true</code> it reverts to the standard <code>elem.val</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, value)</span> {</span>
            <span class="hljs-keyword">var</span> hook;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;lux.set_value_hooks.length; i++) {
                <span class="hljs-keyword">if</span> (lux.set_value_hooks[i](elem, value)) {
                    <span class="hljs-keyword">return</span>;
                }
            }
            elem.val(value);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        addLib: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(info)</span> {</span>
            <span class="hljs-keyword">if</span> (!_.contains(lux.libraries, info.name)) {
                lux.libraries.push(info);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create a random s4 string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        s4: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> (((<span class="hljs-number">1</span>+<span class="hljs-built_in">Math</span>.random())*<span class="hljs-number">0x10000</span>)|<span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Create a UUID4 string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        guid: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> S4 = lux.s4;
            <span class="hljs-keyword">return</span> (S4()+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+S4()+S4());
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        isnothing: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
            <span class="hljs-keyword">return</span> el === <span class="hljs-literal">undefined</span> || el === <span class="hljs-literal">null</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        sorted: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, callback)</span> {</span>
            <span class="hljs-keyword">var</span> sortable = [];
            _(obj).forEch(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, name)</span> {</span>
                sortable.push(name);
            });
            sortable.sort();
            _(sortable).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> {</span>
                callback(obj[name], name);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        niceStr: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(s)</span> {</span>
            <span class="hljs-keyword">return</span> s.capitalize().replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">' '</span>);
        }
    };

    <span class="hljs-built_in">String</span>.prototype.capitalize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.charAt(<span class="hljs-number">0</span>).toUpperCase() + <span class="hljs-keyword">this</span>.slice(<span class="hljs-number">1</span>);
    };

    lux.addLib({name: <span class="hljs-string">'RequireJs'</span>, web: <span class="hljs-string">'http://requirejs.org/'</span>, version: <span class="hljs-built_in">require</span>.version});
    lux.addLib({name: <span class="hljs-string">'Lo-Dash'</span>, web: <span class="hljs-string">'http://lodash.com/'</span>, version: _.VERSION});
    lux.addLib({name: <span class="hljs-string">'jQuery'</span>, web: <span class="hljs-string">'http://jquery.com/'</span>, version: $.fn.jquery});



    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Test for <code>_super</code> method in a <code>Class</code>.</p>
<p>Check <a href="http://ejohn.org/blog/simple-javascript-inheritance/">http://ejohn.org/blog/simple-javascript-inheritance/</a>
for details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fnTest = <span class="hljs-regexp">/xyz/</span>.test(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span><span class="hljs-keyword">var</span> xyz;}) ? <span class="hljs-regexp">/\b_super\b/</span> : <span class="hljs-regexp">/.*/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Create a method for a derived Class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create_method = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, name, attr, _super)</span> {</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attr === <span class="hljs-string">"function"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> _super[name] === <span class="hljs-string">"function"</span> &amp;&amp;
                fnTest.test(attr)) {
            <span class="hljs-keyword">return</span> type.new_attr(name, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> tmp = <span class="hljs-keyword">this</span>._super;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Add a new ._super() method that is the same method
but on the super-class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>._super = _super[name];</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The method only need to be bound temporarily, so we
remove it when we’re done executing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> ret = attr.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
                <span class="hljs-keyword">this</span>._super = tmp;
                <span class="hljs-keyword">return</span> ret;
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> type.new_attr(name, attr);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="-type"> Type</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p> A Type is a factory of Classes. This is the correspondent of
 python metaclasses.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Type = lux.Type = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> {</span>

        t.new_class = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Caller, attrs)</span> {</span>
            <span class="hljs-keyword">var</span> type = <span class="hljs-keyword">this</span>,
                meta = Caller === type,
                _super = meta ? Caller : Caller.prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Instantiate a base class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Caller.initialising = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> prototype = <span class="hljs-keyword">new</span> Caller();
            <span class="hljs-keyword">delete</span> Caller.initialising;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Copy the properties over onto the new prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> attrs) {
                <span class="hljs-keyword">if</span> (name !== <span class="hljs-string">'Metaclass'</span>) {
                    prototype[name] = create_method.call(Caller,
                            type, name, attrs[name], _super);
                }
            }
            <span class="hljs-keyword">if</span> (!meta) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The dummy class constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> constructor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>All construction is actually done in the init method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.constructor.initialising &amp;&amp; <span class="hljs-keyword">this</span>.init ) {
                        <span class="hljs-keyword">this</span>.init.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
                    }
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Populate our constructed prototype object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                constructor.prototype = prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Enforce the constructor to be what we expect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                constructor.prototype.constructor = constructor;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>And make this class extendable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                constructor.extend = Caller.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> constructor;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">for</span> (name <span class="hljs-keyword">in</span> _super) {
                    <span class="hljs-keyword">if</span> (prototype[name] === <span class="hljs-literal">undefined</span>) {
                        prototype[name] = _super[name];
                    }
                }
                <span class="hljs-keyword">return</span> prototype;
            }
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        t.new_attr = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, attr)</span> {</span>
            <span class="hljs-keyword">return</span> attr;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Create a new Class that inherits from this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        t.extend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attrs)</span> {</span>
            <span class="hljs-keyword">return</span> t.new_class(<span class="hljs-keyword">this</span>, attrs);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> t;
    }(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>})),</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="class">Class</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p> Lux base class.
 The <code>extend</code> method is the most important function of this object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Class = lux.Class = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> {</span>
        c.__class__ = Type;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        c.extend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attrs)</span> {</span>
            <span class="hljs-keyword">var</span> type = attrs.Metaclass || <span class="hljs-keyword">this</span>.__class__;
            <span class="hljs-keyword">var</span> cls = type.new_class(<span class="hljs-keyword">this</span>, attrs);
            cls.__class__ = type;
            <span class="hljs-keyword">return</span> cls;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> c;
    }(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>})),</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Class With Events
requires jQuery loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    EventClass = Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Bind this class to a jQuery element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bindToElement: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(jElem)</span> {</span>
            <span class="hljs-keyword">this</span>._jquery_element = jElem;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        trigger: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, params)</span> {</span>
            <span class="hljs-keyword">if</span> (params) {
                <span class="hljs-keyword">if</span> (!_.isArray(params)) params = [params];
                params.splice(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>);
            } <span class="hljs-keyword">else</span> {
                params = [<span class="hljs-keyword">this</span>];
            }
            <span class="hljs-keyword">this</span>.jElem().trigger(name, params);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        on: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, callback)</span> {</span>
            <span class="hljs-keyword">this</span>.jElem().on(name, callback, slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        jElem: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._jquery_element ? <span class="hljs-keyword">this</span>._jquery_element : $(window);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Lux exception:
 throw new lux.Exception(message)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Exception = Class.extend({
        name: <span class="hljs-string">'Exception'</span>,
        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message)</span> {</span>
            <span class="hljs-keyword">this</span>.message = message || <span class="hljs-string">''</span>;
        },
        toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name + <span class="hljs-string">': '</span> + <span class="hljs-keyword">this</span>.message;
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    ModelException = Exception.extend({name: <span class="hljs-string">'ModelException'</span>}),</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    NotImplementedError = Exception.extend({name: <span class="hljs-string">'NotImplementedError'</span>}),</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Default values for <code>Meta</code> attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    default_meta_attributes = {
        <span class="hljs-string">'pkname'</span>: <span class="hljs-string">'id'</span>,
        <span class="hljs-string">'name'</span>: <span class="hljs-string">'model'</span>,
        <span class="hljs-string">'defaults'</span>: {}
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="-model-meta"> Model Meta</h2>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Model database meta-class, accessed as <code>_meta</code> attribute on a <code>Model</code>
instance or from the Model.prototype object. It is a placeholder of
live instances and it is the interface between a model and backend
servers. A <code>Meta</code> must be registered with a backend before it can
use the <code>sync</code> method. Registration is achieved via the
<code>set_transport</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Meta = lux.Meta = Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Initialisation, set the <code>model</code> attribute and the attributes
for this Meta. The available attributes are the same as
<code>default_meta_attributes</code> object above.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, attrs)</span> {</span>
            <span class="hljs-keyword">this</span>.model = model;
            _.extend(<span class="hljs-keyword">this</span>, attrs);
            <span class="hljs-keyword">this</span>.title = <span class="hljs-keyword">this</span>.title || <span class="hljs-keyword">this</span>.name;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Initialise an instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init_instance: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o, fields)</span> {</span>
            o._fields = {};
            o._changed = {};
            o.cid = _.uniqueId(<span class="hljs-string">'model'</span>);
            <span class="hljs-keyword">if</span> (fields === <span class="hljs-built_in">Object</span>(fields)) {
                _(fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field, name)</span> {</span>
                    <span class="hljs-keyword">this</span>.set_field(o, name, field, <span class="hljs-literal">true</span>);
                }, <span class="hljs-keyword">this</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Fetch a bunch of ids from the backend server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ids, options)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._backend) {
                <span class="hljs-keyword">if</span> (!options) {
                    options = {};
                }
                <span class="hljs-keyword">if</span> (!$.isArray(ids)) {
                    ids = [ids];
                }
                <span class="hljs-keyword">var</span> crud = {},
                    meta = <span class="hljs-keyword">this</span>;
                _(ids).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
                    meta._add_to_crud(crud, <span class="hljs-string">'read'</span>, id, options);
                });
                meta._backend.send(crud.read);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ModelException(<span class="hljs-string">'Cannot sync '</span> + <span class="hljs-keyword">this</span> + <span class="hljs-string">'. No backend registered.'</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>update live data with information from the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                all = [],
                instance;
            _(data).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                <span class="hljs-keyword">var</span> instance = self.liveStorage.getItem(o.id);
                <span class="hljs-keyword">if</span> (instance) {
                    instance.update(o.fields);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>reset the changed object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    instance._changed = {};
                } <span class="hljs-keyword">else</span> {
                    instance = <span class="hljs-keyword">new</span> self.model(o.fields);
                }
                all.push(instance);
            });
            <span class="hljs-keyword">return</span> all;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Set a new value for a field.
It returns a value different from undefined
only when the field has changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        set_field: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance, field, value, initialising)</span> {</span>
            <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Check if there is a validater for the field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fields) {
                <span class="hljs-keyword">var</span> f = <span class="hljs-keyword">this</span>.fields[field];
                <span class="hljs-keyword">if</span> (f) {
                    value = f.validate(instance, value);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f === <span class="hljs-literal">null</span>) {
                    instance[field] = value;
                    <span class="hljs-keyword">return</span>;
                }
            }
            <span class="hljs-keyword">if</span> (initialising) {
                instance._fields[field] = value;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> prev = instance.get(field);
                <span class="hljs-keyword">if</span> (_.isEqual(value, prev)) <span class="hljs-keyword">return</span>;
                instance._fields[field] = value;
                <span class="hljs-keyword">return</span> prev === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : prev;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h2 id="metaclass-for-models">Metaclass for models</h2>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Override the standard <code>Type</code> so that the new model class
contains the <code>_meta</code> attribute, and instance of <code>Meta</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ModelType = lux.ModelType = Type.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        new_class: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Prototype, attrs)</span> {</span>
            attrs || (attrs = {});
            <span class="hljs-keyword">var</span> meta = Prototype._meta,
                mattrs = _.merge({}, default_meta_attributes, attrs.meta);</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Make sure we inherit fields for parent models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (meta &amp;&amp; meta.fields) {
                mattrs.fields = <span class="hljs-keyword">this</span>.mergeFields([meta.fields, mattrs.fields]);
            }
            <span class="hljs-keyword">var</span> cls = <span class="hljs-keyword">this</span>._super(Prototype, attrs);
            cls._meta = cls.prototype._meta = <span class="hljs-keyword">new</span> Meta(cls, mattrs);
            <span class="hljs-keyword">return</span> cls;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        mergeFields: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(groups)</span> {</span>
            <span class="hljs-keyword">var</span> map = {},
                list = [],
                merged = [];
            _(groups).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fields)</span> {</span>
                _(fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> {</span>
                    <span class="hljs-keyword">if</span> (map[field.name]) {
                        map[field.name] = field;
                    } <span class="hljs-keyword">else</span> {
                        map[field.name] = field;
                        list.push(field.name);
                    }
                });
            });
            _(list).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> {</span>
                merged.push(map[name]);
            });
            <span class="hljs-keyword">return</span> merged;
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h2 id="model">Model</h2>
<p>The base class for a model. A model is a single, definitive source
of data about your data. A Model consists of <code>fields</code> and behaviours
of the data you are storing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Model = lux.Model = EventClass.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Model uses a specialised metaclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Metaclass: ModelType,</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            <span class="hljs-keyword">this</span>._meta.init_instance(<span class="hljs-keyword">this</span>, data);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Primary key value. If the model is not persistent (not in <code>sync</code> with
the backend) it can be undefined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pk: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(<span class="hljs-keyword">this</span>._meta.pkname);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Has this model been saved to the server yet? If the model does
not yet have a pk value, it is considered to be new.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        isNew: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pk() ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        isDeleted: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._deleted === <span class="hljs-literal">true</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Object containing all fields for this model instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fields: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._fields;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Return a shallow copy of the model’s attributes for JSON
stringification.
This can be used for persistence, serialization, or for augmentation
before being sent to the server.
If <code>changed</code> is <code>true</code> it returnes only fields which
have changed if the model is already persistent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(changed)</span> {</span>
            <span class="hljs-keyword">var</span> data = {},
                fields = <span class="hljs-keyword">this</span>._fields,
                all = fields;
            <span class="hljs-keyword">if</span> (changed &amp;&amp; !<span class="hljs-keyword">this</span>.isNew()) all = <span class="hljs-keyword">this</span>._changed;
            _(all).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, name)</span> {</span>
                value = fields[name];
                <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
                    data[name] = <span class="hljs-number">0.001</span>*value.getTime();
                } <span class="hljs-keyword">else</span> {
                    data[name] = value;
                }
            });
            <span class="hljs-keyword">return</span> data;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Set a field value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field, value)</span> {</span>
            <span class="hljs-keyword">var</span> prev = <span class="hljs-keyword">this</span>._meta.set_field(<span class="hljs-keyword">this</span>, field, value);
            <span class="hljs-keyword">if</span> (prev !== <span class="hljs-literal">undefined</span>) {
                <span class="hljs-keyword">this</span>._changed[field] = prev;
                <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'change'</span>, [<span class="hljs-keyword">this</span>, field]);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        changedFields: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fields)</span> {</span>
            <span class="hljs-keyword">if</span> (!fields) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._changed;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(fields) === <span class="hljs-string">'string'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._changed[fields];
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._changed;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        hasChanged: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> _.size(<span class="hljs-keyword">this</span>._changed) &gt; <span class="hljs-number">0</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        previous: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._changed[field];
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>get a field value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._fields[field];
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Update fields with new values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fields)</span> {</span>
            <span class="hljs-keyword">if</span> (fields === <span class="hljs-built_in">Object</span>(fields)) {
                <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                _(fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, name)</span> {</span>
                    self.set(name, value);
                });
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">'delete'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._deleted = <span class="hljs-literal">true</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Sync a model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sync: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(store, options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">var</span> callback = options.success,
                info = <span class="hljs-keyword">this</span>._sync_data(options),
                self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (info) {
                info.model = <span class="hljs-keyword">this</span>._meta.name;
                info.success = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, status, response)</span> {</span>
                    self.sync_callback(data, status, response);
                    <span class="hljs-keyword">if</span> (callback) callback(self);
                };
                <span class="hljs-keyword">return</span> store.execute(info);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (callback) {
                callback(self);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Calledback after a <code>sync</code> has terminated with success
Override  if you need to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sync_callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, status, response)</span> {</span>
            <span class="hljs-keyword">if</span> (response.status === <span class="hljs-number">200</span> || response.status === <span class="hljs-number">201</span>) {
                <span class="hljs-keyword">this</span>._changed = {};
                <span class="hljs-keyword">this</span>.update(data);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.crud === Crud.delete) {
                <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'deleted'</span>);
            } <span class="hljs-keyword">else</span> {
                logger.warning(<span class="hljs-string">'Could not understand response'</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._meta.name + <span class="hljs-string">'-'</span> + <span class="hljs-keyword">this</span>.cid;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p> Get a <code>Form</code> view for this model.</p>
<p> By default all fields defined in the metaclass are added
 to the form. Override if you need to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getForm: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            options.model = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> form = <span class="hljs-keyword">new</span> Form(options);
            form.setFields(<span class="hljs-keyword">this</span>._meta.fields);
            <span class="hljs-keyword">if</span> (options.callback) options.callback(form);
            <span class="hljs-keyword">return</span> form;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Update the input/select elements in a jQuery form element with data
from the model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        updateForm: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(form)</span> {</span>
            _(<span class="hljs-keyword">this</span>.fields()).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val, name)</span> {</span>
                <span class="hljs-keyword">var</span> elem = form.find(<span class="hljs-string">"[name="</span> + name + <span class="hljs-string">"]"</span>);
                <span class="hljs-keyword">if</span> (elem.length) {
                    lux.setValue(elem, val);
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Replace fields with a new set
If available fields are not present in <code>new_fields</code>, they will be
removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        replace: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(new_fields)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _(<span class="hljs-keyword">this</span>._fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, name)</span> {</span>
                <span class="hljs-keyword">if</span> (new_fields[name] === <span class="hljs-literal">undefined</span>) {
                    <span class="hljs-keyword">delete</span> self._fields[name];
                    self.trigger(<span class="hljs-string">'change'</span>, name);
                }
            });
            <span class="hljs-keyword">this</span>.update(new_fields);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p> Private method which return serialised representation of model
 data for synchronisation with backend store.
 It returns an object containing:</p>
<ul>
<li><code>crud</code> - the CRUD action to perform (<code>create</code>, <code>update</code> or <code>delete</code>)</li>
<li><code>item</code> - object containg the following entries<ul>
<li><code>pk</code> primary key (not available for <code>create</code> action)</li>
<li><code>fields</code> - object with model fields (not available for <code>delete</code> action)</li>
<li><code>cid</code> - custom identifier</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _sync_data: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">var</span> pkvalue = <span class="hljs-keyword">this</span>.pk();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDeleted() &amp;&amp; pkvalue) {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>DELETE THE MODEL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                options.crud = Crud.delete;
                options.item = {
                    pk: pkvalue
                };
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pkvalue &amp;&amp; <span class="hljs-keyword">this</span>.hasChanged()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>UPDATE THE MODEL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                options.crud = Crud.update;
                options.item = {
                    pk: pkvalue,
                    data: <span class="hljs-keyword">this</span>.toJSON()
                };
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!pkvalue) {</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>CREATE A NEW MODEL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> o = <span class="hljs-keyword">this</span>.toJSON();
                <span class="hljs-keyword">if</span> (_.size(o)) {
                    options.crud = Crud.create;
                    options.item = {data: o};
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span>;
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">return</span> options;
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h2 id="-collection-of-models"> Collection of Models</h2>

            </div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p> A collection maintain an ordered group of model instances</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Collection = lux.Collection = Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, store)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                _data = [],
                _map = {},
                NewModel = self.model = model || Model.extend({});
            self.store = create_store(store);


            <span class="hljs-built_in">Object</span>.defineProperty(self, <span class="hljs-string">'length'</span>, {
                get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">return</span> _data.length;
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _.extend(self, {</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Get a model from a collection, specified by index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                at: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> {</span>
                    <span class="hljs-keyword">var</span> id = _data[index];
                    <span class="hljs-keyword">if</span> (id) <span class="hljs-keyword">return</span> _map[id];
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Get a model from a collection, specified by an id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
                    <span class="hljs-keyword">return</span> _map[id];
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Add a model (or an array of models) to the collection,
firing an “add” event.</p>
<ul>
<li>Can pass raw attributes objects, and have them be
vivified as instances of the model.</li>
<li>Returns the added (or preexisting, if duplicate) models.</li>
<li>Pass {at: index} to splice the model into the collection at
the specified index.</li>
<li>If you’re adding models to the collection that are already
in the collection, they’ll be ignored, unless you pass
<code>{merge: true}</code>, in which case their attributes will
be merged into the corresponding models, firing any
appropriate “change” events.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                add: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data, options)</span> {</span>
                    <span class="hljs-keyword">var</span> models = [],
                        existing;</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                    options || (options = {});
                    <span class="hljs-keyword">if</span> (!_.isArray(data)) {
                        data = [data];
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                    _(data).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o)</span> {</span>
                        <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> NewModel)) {
                            o = <span class="hljs-keyword">new</span> NewModel(o);
                        }
                        existing = _map[o.cid];
                        <span class="hljs-keyword">if</span> (existing) {
                            <span class="hljs-keyword">if</span> (options.merge) {
                                existing.update(o.fields());
                                <span class="hljs-keyword">if</span> (existing.hasChanged()) {
                                    models.push(existing);
                                }
                            }
                        } <span class="hljs-keyword">else</span> {
                            _map[o.cid] = o;
                            _data.push(o.cid);
                            models.push(o);
                        }
                    });
                    <span class="hljs-keyword">return</span> models;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(models)</span> {</span>
                    _(models).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model)</span> {</span>
                        <span class="hljs-keyword">var</span> id = model.id(),
                            existing = _map[id];
                        <span class="hljs-keyword">if</span> (existing) {
                            existing.update(model.fields());
                        } <span class="hljs-keyword">else</span> {
                            _map[id] = model;
                            _data.push(id);
                        }
                    });
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Clear the collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                clear: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    _data = [];
                    _map = {};
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                forEach: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                    <span class="hljs-keyword">var</span> len = _data.length,
                        res;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;len; i++) {
                        <span class="hljs-keyword">if</span>(callback(_map[_data[i]], i) === <span class="hljs-literal">false</span>) <span class="hljs-keyword">break</span>;
                    }
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                    self.forEach(callback);
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        reset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(models)</span> {</span>
            <span class="hljs-keyword">this</span>.clear();
            <span class="hljs-keyword">this</span>.set(models);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Fetch a new Collection of models from the store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fetch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (!options.success) {
                options.success || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
                    data = self.parse(data);
                    self.reset(data);
                };
            }
            options.meta = <span class="hljs-keyword">this</span>.model._meta;
            self.store.execute(options);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p> Commit changes to backend store</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sync: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                store = <span class="hljs-keyword">this</span>.store,
                groups = {},
                callback = options.success,
                errback = options.error,
                group, item;

            <span class="hljs-keyword">this</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model)</span> {</span>
                model.sync(store, options);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Parse data into a collection of models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        parse: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            <span class="hljs-keyword">return</span> data;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.model._meta.name + <span class="hljs-string">'['</span> + <span class="hljs-keyword">this</span>.length + <span class="hljs-string">']'</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        afterSync: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(op, data)</span> {</span>
            <span class="hljs-keyword">if</span> (op === Crud.delete) {

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op === Crud.create) {
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op === Crud.update) {
            }
        }
    });



    lux.EventClass = EventClass;
    lux.Exception = Exception;
    lux.ModelException = ModelException;
    lux.NotImplementedError = NotImplementedError;</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <h2 id="-view"> View</h2>
<p> A <code>View</code> is a way of to organize your interface into logical views,
 backed by models, each of which can be updated independently when
 the model changes, without having to redraw the page.
 Instead of digging into a JSON object, looking up an element in
 the DOM, and updating the HTML by hand, you can bind your view’s
 render function to the model’s “change” event — and now everywhere
 that model data is displayed in the UI, it is always
 immediately up to date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    autoViews = lux.autoViews = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    SKIN_NAMES = lux.SKIN_NAMES = [<span class="hljs-string">'default'</span>, <span class="hljs-string">'primary'</span>, <span class="hljs-string">'success'</span>, <span class="hljs-string">'inverse'</span>, <span class="hljs-string">'error'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Extract a skin information from <code>elem</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getSkin = lux.getSkin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, prefix)</span> {</span>
        <span class="hljs-keyword">if</span> (elem) {
            prefix = prefix ? prefix + <span class="hljs-string">'-'</span> : <span class="hljs-string">''</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &lt; SKIN_NAMES.length; i++) {
                <span class="hljs-keyword">var</span> name = SKIN_NAMES[i];
                <span class="hljs-keyword">if</span> (elem.hasClass(prefix+name)) {
                    <span class="hljs-keyword">return</span> name;
                }
            }
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Set the skin on an element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setSkin = lux.setSkin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, skin, prefix)</span> {</span>
        <span class="hljs-keyword">if</span> (SKIN_NAMES.indexOf(skin) &gt; -<span class="hljs-number">1</span>) {
            prefix = prefix ? prefix + <span class="hljs-string">'-'</span> : <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _(SKIN_NAMES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> {</span>
                elem.removeClass(prefix+name);
            });
            elem.addClass(prefix+skin);
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Cached regex to split keys for <code>delegate</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    delegateEventSplitter = <span class="hljs-regexp">/^(\S+)\s*(.*)$/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    viewOptions = [<span class="hljs-string">'model'</span>, <span class="hljs-string">'collection'</span>, <span class="hljs-string">'elem'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'attributes'</span>,
                   <span class="hljs-string">'className'</span>, <span class="hljs-string">'tagName'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'events'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>A view class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    View = lux.View = Class.extend({
        tagName: <span class="hljs-string">'div'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>This method should not be overwritten, use the <code>initialise</code>
method instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">this</span>.cid = _.uniqueId(<span class="hljs-string">'view'</span>);
            options || (options = {});
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaults) {
                options = _.extend({}, <span class="hljs-keyword">this</span>.defaults, options);
            }
            _.extend(<span class="hljs-keyword">this</span>, _.pick(options, viewOptions));
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.elem) {
                <span class="hljs-keyword">this</span>.setElement($(document.createElement(<span class="hljs-keyword">this</span>.tagName)), <span class="hljs-literal">false</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.elem = $(_.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'elem'</span>));
                <span class="hljs-keyword">this</span>.setElement(<span class="hljs-keyword">this</span>.elem, <span class="hljs-literal">false</span>);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.instance_key) <span class="hljs-keyword">this</span>.elem.data(<span class="hljs-keyword">this</span>.instance_key, <span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">this</span>.initialise(options);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Callat the end of the <code>init</code> method.
A chance to perform view specific initialisation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>},

        remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.elem.remove();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },

        delegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(events)</span> {</span>
            events = events || <span class="hljs-keyword">this</span>.events;
            <span class="hljs-keyword">if</span> (!events) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>.undelegateEvents();
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> events) {
                <span class="hljs-keyword">var</span> method = events[key];
                <span class="hljs-keyword">if</span> (!_.isFunction(method)) method = <span class="hljs-keyword">this</span>[method];
                <span class="hljs-keyword">if</span> (!method) <span class="hljs-keyword">continue</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> match = key.match(delegateEventSplitter);
                <span class="hljs-keyword">var</span> eventName = match[<span class="hljs-number">1</span>], selector = match[<span class="hljs-number">2</span>];
                method = _.bind(method, <span class="hljs-keyword">this</span>);
                eventName += <span class="hljs-string">'.delegateEvents'</span> + <span class="hljs-keyword">this</span>.cid;
                <span class="hljs-keyword">if</span> (selector === <span class="hljs-string">''</span>) {
                    <span class="hljs-keyword">this</span>.elem.on(eventName, method);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.elem.on(eventName, selector, method);
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },

        undelegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.elem.off(<span class="hljs-string">'.delegateEvents'</span> + <span class="hljs-keyword">this</span>.cid);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },

        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        setElement: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, delegate)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.elem) <span class="hljs-keyword">this</span>.undelegateEvents();
            <span class="hljs-keyword">this</span>.elem = $(elem);
            <span class="hljs-keyword">if</span> (delegate !== <span class="hljs-literal">false</span>) <span class="hljs-keyword">this</span>.delegateEvents();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Immediately show the <code>elem</code> and fire ‘show’ event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        show: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.elem.show();
            <span class="hljs-keyword">this</span>.elem.trigger(<span class="hljs-string">'show'</span>, <span class="hljs-keyword">this</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Immediately hide the <code>elem</code> and fire ‘hide’ event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        hide: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.elem.hide();
            <span class="hljs-keyword">this</span>.elem.trigger(<span class="hljs-string">'hide'</span>, <span class="hljs-keyword">this</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>fadeIn the jQuery element.
Once the fadeIn action is finished a trigger the <code>show</code>
event and invoke the optional <code>callback</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fadeIn: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">if</span> (!options.complete) {
                <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                options.complete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    self.show();
                };
            }
            <span class="hljs-keyword">this</span>.elem.fadeIn(options);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>fadeOut the jQuery element conteining the extension.
Once the fadeOut action is finished a trigger the <code>hide</code>
event and invoke the optional <code>callback</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fadeOut: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">if</span> (!options.complete) {
                <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                options.complete = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    self.hide();
                };
            }
            <span class="hljs-keyword">this</span>.elem.fadeOut(options);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Get the skin name for this view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getSkin: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(prefix)</span> {</span>
            <span class="hljs-keyword">return</span> lux.getSkin(<span class="hljs-keyword">this</span>.elem, prefix || <span class="hljs-keyword">this</span>.className);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Set the skin for this view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setSkin: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(skin, prefix)</span> {</span>
            lux.setSkin(<span class="hljs-keyword">this</span>.elem, skin, prefix || <span class="hljs-keyword">this</span>.className);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        eventName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> {</span>
            <span class="hljs-keyword">var</span> namespace = <span class="hljs-keyword">this</span>.instance_key ? <span class="hljs-keyword">this</span>.instance_key : <span class="hljs-string">'view'</span>;
            <span class="hljs-keyword">return</span> event + <span class="hljs-string">'.lux.'</span> + namespace;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        enforceFocus: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.eventName(<span class="hljs-string">'focusin'</span>),
                self = <span class="hljs-keyword">this</span>;
            $(document).off(name).on(name, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                <span class="hljs-keyword">if</span> (self.elem[<span class="hljs-number">0</span>] !== e.target &amp;&amp; !self.elem.has(e.target).length)
                    self.elem.trigger(<span class="hljs-string">'focus'</span>);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Add a stylesheet to the head tag.</p>
<p> <code>rules</code> is an array of string with css rules
 <code>id</code> optional id to set in the style tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addStyle: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(rules, id)</span> {</span>
            <span class="hljs-keyword">if</span> (rules.length) {
                <span class="hljs-keyword">var</span> head = $(<span class="hljs-string">"head"</span>),
                    style;
                <span class="hljs-keyword">if</span> (id) {
                    style = head.find(<span class="hljs-string">'#'</span> + id);
                    <span class="hljs-keyword">if</span> (!style.length) style = <span class="hljs-literal">null</span>;
                }
                <span class="hljs-keyword">if</span> (!style) {
                    style = $(<span class="hljs-string">"&lt;style type='text/css' rel='stylesheet' /&gt;"</span>
                        ).appendTo(head).attr(<span class="hljs-string">'id'</span>, id);
                    <span class="hljs-keyword">if</span> (style[<span class="hljs-number">0</span>].styleSheet) { <span class="hljs-comment">// IE</span>
                        style[<span class="hljs-number">0</span>].styleSheet.cssText = rules.join(<span class="hljs-string">"\n"</span>);
                    } <span class="hljs-keyword">else</span> {
                        style[<span class="hljs-number">0</span>].appendChild(document.createTextNode(rules.join(<span class="hljs-string">"\n"</span>)));
                    }
                }
            }
        },
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p> Create a new View and perform additional action such as:</p>
<ul>
<li>Create a jQuery plugin if the <code>obj</code> has the <code>jQuery</code> attribute
set to <code>true</code>.</li>
<li>Register the view for autoloading if the <code>selector</code> attribute is
available.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.createView = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, obj, BaseView)</span> {</span>
        <span class="hljs-keyword">var</span> jQuery = obj.jQuery,
            key = name + <span class="hljs-string">'-view'</span>;
        <span class="hljs-keyword">delete</span> obj.jQuery;</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        obj.name = name;
        obj.instance_key = key;
        BaseView = BaseView || View;</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Build the new View</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> NewView = BaseView.extend(obj),
            proto = NewView.prototype,</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>view’s factory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            create = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, options, render)</span> {</span>
                <span class="hljs-keyword">var</span> view = elem.data(key);
                <span class="hljs-keyword">if</span> (!view) {
                    options || (options = {});
                    <span class="hljs-keyword">if</span> (lux.data_api)
                        options = _.extend({}, elem.data(), options);
                    options.elem = elem;
                    view = <span class="hljs-keyword">new</span> NewView(options);
                    <span class="hljs-keyword">if</span> (render) view.render();
                }
                <span class="hljs-keyword">return</span> view;
            };

        NewView.getInstance = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem)</span> {</span>
            <span class="hljs-keyword">return</span> elem.data(key);
        };

        <span class="hljs-keyword">if</span> (jQuery) {
            $.fn[name] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
                <span class="hljs-keyword">if</span> (options === <span class="hljs-string">'instance'</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data(key);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> create(<span class="hljs-keyword">this</span>, options).elem;
                }
            };
        }

        <span class="hljs-keyword">if</span> (proto.selector) {
            autoViews.push({
                selector: proto.selector,
                load: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
                    create($(elem), <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
                }
            });
        }
        <span class="hljs-keyword">return</span> NewView;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p> Load all registered views into <code>elem</code></p>
<p> If <code>elem</code> is not provided load registered views into the
 whole document.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.loadViews = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
        elem = $(elem || document);
        _(autoViews).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(view)</span> {</span>
            $(view.selector, elem).each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                view.load(<span class="hljs-keyword">this</span>);
            });
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Callback for requires</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.initWeb = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        $(document).ready(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> doc = $(<span class="hljs-keyword">this</span>),
                data = doc.find(<span class="hljs-string">'html'</span>).data() || {},
                body = doc.find(<span class="hljs-string">'body'</span>);
            _.extend(lux, data);
            <span class="hljs-keyword">if</span> (lux.debug) {
                logger.config({level: <span class="hljs-string">'debug'</span>});
                <span class="hljs-keyword">if</span> (!logger.handlers.length) {
                    logger.addHandler();
                }
            }
            body.css({opacity: <span class="hljs-number">0</span>});
            <span class="hljs-keyword">try</span> {
                lux.loadViews(doc);
                body.fadeIn(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">finally</span> {
                body.css({opacity: <span class="hljs-number">1</span>});
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <h2 id="-lux-logger"> Lux Logger</h2>

            </div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Usage:</p>
<pre><code> logger = <span class="hljs-keyword">new</span> Logger();
 logger.info(<span class="hljs-string">'info message'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span>
    log_mapping = {
        <span class="hljs-string">'debug'</span>: <span class="hljs-number">10</span>,
        <span class="hljs-string">'info'</span>: <span class="hljs-number">20</span>,
        <span class="hljs-string">'warning'</span>: <span class="hljs-number">30</span>,
        <span class="hljs-string">'error'</span>: <span class="hljs-number">40</span>,
        <span class="hljs-string">'critical'</span>: <span class="hljs-number">50</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    default_level = <span class="hljs-string">'info'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    Logger = lux.Logger = Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(opts, parent)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>children for this logger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                children = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>config object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                config = {
                    level: default_level,</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                    formatter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, level)</span> {</span>
                        <span class="hljs-keyword">return</span> level + <span class="hljs-string">': '</span> + msg;
                    }
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Logging shortcut methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _(log_mapping).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(n, level)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                self[level] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
                    self.log(msg, level);
                };
            });

            _.extend(self, {
                handlers: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                config: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(opts)</span> {</span>
                    opts = <span class="hljs-built_in">Object</span>(opts);
                    <span class="hljs-keyword">if</span> (opts.level &amp;&amp; log_mapping[opts.level]) {
                        config.level = opts.level;
                    }
                    <span class="hljs-keyword">return</span> config;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                getConfig: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">return</span> config;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                log: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, level)</span> {</span>
                    <span class="hljs-keyword">var</span> nlevel = log_mapping[level] || <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">if</span> (nlevel &gt; log_mapping[config.level]) {
                        <span class="hljs-keyword">var</span> handlers = self.getHandlers(),
                            hnd;

                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;handlers.length; i++) {
                            hnd = handlers[i];
                            <span class="hljs-keyword">if</span> (nlevel &gt;= hnd.nlevel) hnd.log(msg, level);
                        }
                    }
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> {</span>
                    <span class="hljs-keyword">var</span> log = children[name];
                    <span class="hljs-keyword">if</span> (!log) {
                        log = <span class="hljs-keyword">new</span> Logger({namespace: name}, self);
                        children[name] = log;
                    }
                    <span class="hljs-keyword">return</span> log;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                getHandlers: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (!self.handlers.length &amp;&amp; parent) {
                        <span class="hljs-keyword">return</span> parent.getHandlers();
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">return</span> self.handlers;
                    }
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            self.config(opts);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        addHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, handler)</span> {</span>
            handler = handler || <span class="hljs-keyword">new</span> LogHandler();
            handler.config(_.extend({}, <span class="hljs-keyword">this</span>.getConfig(), options));
            <span class="hljs-keyword">this</span>.handlers.push(handler);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <h2 id="-default-loghandler"> Default LogHandler</h2>
<p> Logs messages to the console</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    LogHandler = lux.LogHandler = Class.extend({

        config: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            _.extend(<span class="hljs-keyword">this</span>, options);
            <span class="hljs-keyword">this</span>.nlevel = log_mapping[<span class="hljs-keyword">this</span>.level] || <span class="hljs-number">0</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        log: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg, level)</span> {</span>
            console.log(<span class="hljs-keyword">this</span>.formatter(msg, level));
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <h2 id="-html-loghandler"> HTML LogHandler</h2>
<p> Logs messages to an HTML element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    HtmlHandler = lux.HtmlLogHandler = LogHandler.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
            <span class="hljs-keyword">this</span>.elem = $(elem);
            <span class="hljs-keyword">this</span>.elem.addClass(<span class="hljs-string">'lux-logger'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        log: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg, level)</span> {</span>
            msg = <span class="hljs-keyword">this</span>.formatter(msg, level);
            msg = <span class="hljs-string">'&lt;pre class="'</span> + level + <span class="hljs-string">'"&gt;'</span> + msg + <span class="hljs-string">'&lt;/pre&gt;'</span>;
            <span class="hljs-keyword">this</span>.elem.prepend(msg);
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p> Create the root logger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> logger = <span class="hljs-keyword">new</span> Logger();</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.getLogger = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(namespace, options)</span> {</span>
        <span class="hljs-keyword">var</span> log = logger;
        <span class="hljs-keyword">if</span> (namespace) {
            _.each(namespace.split(<span class="hljs-string">'.'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> {</span>
                log = log.get(name);
            });
        }
        <span class="hljs-keyword">if</span> (options) {
            log.config(options);
        }
        <span class="hljs-keyword">return</span> log;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>CRUD actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Crud = {
        create: <span class="hljs-string">'create'</span>,
        read: <span class="hljs-string">'read'</span>,
        update: <span class="hljs-string">'update'</span>,
        <span class="hljs-string">'delete'</span>: <span class="hljs-string">'delete'</span>,
    },
    CrudMethod = lux.CrudMethod = {
        create: <span class="hljs-string">'POST'</span>,
        read: <span class="hljs-string">'GET'</span>,
        update: <span class="hljs-string">'PUT'</span>,
        destroy: <span class="hljs-string">'DELETE'</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    stores = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    register_store = lux.register_store = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(scheme, Store)</span> {</span>
        stores[scheme] = Store;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Create a new Backend Store from a <code>store</code> url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create_store = lux.create_store = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(store, options)</span> {</span>
        <span class="hljs-keyword">if</span> (store <span class="hljs-keyword">instanceof</span> Backend) {
            <span class="hljs-keyword">return</span> store;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isString(store)) {
            <span class="hljs-keyword">var</span> idx = store.search(<span class="hljs-string">'://'</span>),
                scheme = idx === -<span class="hljs-number">1</span> ? <span class="hljs-string">'http'</span> : store.substr(<span class="hljs-number">0</span>, idx),
                Store = stores[scheme];
            <span class="hljs-keyword">if</span> (Store &amp;&amp; store)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Store(store, options, scheme);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>A dummy backend</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Backend(store, options, <span class="hljs-string">'dummy'</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Base class for backends to use when synchronising Models</p>
<p>Usage::</p>
<pre><code> backend = lux.Socket(<span class="hljs-string">'ws://...'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> Backend = lux.Backend = lux.Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        options: {
            dataType: <span class="hljs-string">'json'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url, options, type)</span> {</span>
            <span class="hljs-keyword">this</span>.type = type;
            <span class="hljs-keyword">this</span>.url = url;
            <span class="hljs-keyword">this</span>.options = _.merge({}, <span class="hljs-keyword">this</span>.options, options);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>The synchoronisation method</p>
<p>It has an API which match jQuery.ajax method</p>
<p>Available options entries:</p>
<ul>
<li><code>beforeSend</code> A pre-request callback function that can be used to
modify the object before it is sent. Returning false will cancel the
execution.</li>
<li><code>error</code> callback invoked if the execution fails</li>
<li><code>meta</code> optional Model metadata</li>
<li><code>model</code> optional Model instance</li>
<li><code>success</code> callback invoked on a successful execution</li>
<li><code>type</code> the type of CRUD operation</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        execute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">if</span> (options.success) {
                options.success([]);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        toString: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type + <span class="hljs-string">' '</span> + <span class="hljs-keyword">this</span>.url;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <h2 id="-ajax-backend"> AJAX Backend</h2>
<p> Uses jQuery.ajax method to execute CRUD operations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> AjaxBackend = lux.Backend.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url, options, type)</span> {</span>
            <span class="hljs-keyword">this</span>._super(url, options, <span class="hljs-string">'ajax'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>The ajax execute method for single model or group of models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        execute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.url,
                model = options.model,
                item = options.item;
            <span class="hljs-keyword">delete</span> options.model;</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            options.type = lux.CrudMethod[options.crud] || options.type || <span class="hljs-string">'GET'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>If a model is given, this is an operation on a single instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (item) {
                <span class="hljs-keyword">delete</span> options.item;</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>primary key given, change url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (item.pk) url = lux.utils.urljoin(url, item.pk);
                options.data = item.data;
            }
            $.ajax(url, options);
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    register_store(<span class="hljs-string">'http'</span>, AjaxBackend);
    register_store(<span class="hljs-string">'https'</span>, AjaxBackend);</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <h2 id="-websocket-backend"> WebSocket Backend</h2>
<p> Uses lux websocket CRUD protocol</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> Socket = lux.Backend.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        options: {
            resource: <span class="hljs-literal">null</span>,
            reconnecting: <span class="hljs-number">1</span>,
            hartbeat: <span class="hljs-number">5</span>,
            maxDelay: <span class="hljs-number">3600</span>,
            maxRetries: <span class="hljs-literal">null</span>,
            factor: <span class="hljs-number">2.7182818284590451</span>, <span class="hljs-comment">// (e)</span>
            jitters: <span class="hljs-number">0</span>,
            jitter: <span class="hljs-number">0.11962656472</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url, options, type)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            url = <span class="hljs-keyword">this</span>.websocket_uri(url);
            <span class="hljs-keyword">this</span>._super(url, options, <span class="hljs-string">'websocket'</span>);
            <span class="hljs-keyword">this</span>._retries = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">this</span>._transport = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>._opened = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>._pending_messages = {};
            <span class="hljs-keyword">this</span>._delay = <span class="hljs-keyword">this</span>.options.reconnecting;
            <span class="hljs-keyword">this</span>._queue = [];
            self.connect();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        opened: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._opened;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Connect the websocket
This method can be called several times by the
reconnect method (reconnecting must be positive).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        connect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>.options,
                uri = <span class="hljs-keyword">this</span>.url,
                self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (options.resource) {
                uri += options.resource;
            }
            logger.info(<span class="hljs-string">'Connecting with '</span> + self);
            <span class="hljs-keyword">this</span>._transport = <span class="hljs-keyword">new</span> WebSocket(uri);
            <span class="hljs-keyword">this</span>._transport.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.onopen();
            };
            <span class="hljs-keyword">this</span>._transport.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                <span class="hljs-keyword">if</span> (e.type === <span class="hljs-string">'message'</span>) {
                    self.onmessage(e);
                }
            };
            <span class="hljs-keyword">this</span>._transport.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.onclose();
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        onopen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._opened = <span class="hljs-literal">true</span>;
            logger.info(<span class="hljs-keyword">this</span> + <span class="hljs-string">' opened.'</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.onopen) {
                <span class="hljs-keyword">this</span>.options.onopen.call(<span class="hljs-keyword">this</span>);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._queue) {
                <span class="hljs-keyword">var</span> queue = <span class="hljs-keyword">this</span>._queue;
                <span class="hljs-keyword">this</span>._queue = [];
                _(queue).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
                    <span class="hljs-keyword">this</span>._transport.send(msg);
                }, <span class="hljs-keyword">this</span>);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        reconnect: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> o = <span class="hljs-keyword">this</span>.options,
                self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._delay) {
                logger.info(<span class="hljs-string">'Exiting websocket'</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">this</span>._retries += <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (o.maxRetries !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">this</span>._retries &gt; o.maxRetries)) {
                logger.info(<span class="hljs-string">'Exiting websocket after '</span> + <span class="hljs-keyword">this</span>.retries + <span class="hljs-string">' retries.'</span>);
                <span class="hljs-keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._delay = <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>._delay * o.factor, o.maxDelay);
            <span class="hljs-keyword">if</span> (o.jitter) {
                <span class="hljs-keyword">this</span>._delay = lux.math.normalvariate(<span class="hljs-keyword">this</span>._delay, <span class="hljs-keyword">this</span>._delay * o.jitter);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            logger.info(<span class="hljs-string">'Try to reconnect websocket in '</span> + <span class="hljs-keyword">this</span>._delay + <span class="hljs-string">' seconds'</span>);
            <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'reconnecting'</span>, <span class="hljs-keyword">this</span>._delay);
            <span class="hljs-keyword">this</span>._reconnect = lux.eventloop.call_later(<span class="hljs-keyword">this</span>._delay, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                self._reconnect = <span class="hljs-literal">null</span>;
                self.connect();
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Send a set of operations to the backend
If <code>options</code> contains the <code>item</code> entry, than it is converted into
a sinle <code>data</code> entry <code>options.data = [options.item]</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        execute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">if</span> (options.beforeSend &amp;&amp; options.beforeSend.call(options, <span class="hljs-keyword">this</span>) === <span class="hljs-literal">false</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Don’t send anything, simply return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> obj = {</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>new message id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                mid: <span class="hljs-keyword">this</span>.new_mid(options),
                action: options.action || lux.CrudMethod[options.crud] || options.crud,
                model: options.model
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>This is an execution for a single item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (options.item) {
                _.extend(obj, options.item);
            } <span class="hljs-keyword">else</span> {
                obj.data = options.data;
            }
            obj = <span class="hljs-built_in">JSON</span>.stringify(obj);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._opened) {
                <span class="hljs-keyword">this</span>._transport.send(obj);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>._queue.push(obj);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Handle incoming messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onmessage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">JSON</span>.parse(e.data),
                mid = obj.mid,
                options = mid ? <span class="hljs-keyword">this</span>._pending_messages[mid] : <span class="hljs-literal">undefined</span>,
                data = obj.data;
            obj.response = e;
            obj.backend = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (options) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._pending_messages[mid];
            }
            <span class="hljs-keyword">if</span> (obj.error) {
                <span class="hljs-keyword">if</span> (options &amp;&amp; options.error) {
                    options.error(obj, <span class="hljs-string">'error'</span>, obj.error);
                } <span class="hljs-keyword">else</span> {
                    logger.error(<span class="hljs-keyword">this</span>.toString() + <span class="hljs-string">' - '</span> + obj.error);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (options &amp;&amp; options.success) {
                    options.success(data, <span class="hljs-string">'success'</span>, obj);
                } <span class="hljs-keyword">else</span> {
                    logger.warning(
                        <span class="hljs-keyword">this</span>.toString() + <span class="hljs-string">' - Got message with no callback registered'</span>);
                }
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>The socket is closed
If enabled, it auto-reconnects with an exponential back-off</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onclose: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>._opened = <span class="hljs-literal">false</span>;
            logger.warning(<span class="hljs-keyword">this</span> + <span class="hljs-string">' closed.'</span>);
            <span class="hljs-keyword">this</span>.reconnect();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Create a new message id and add the options object to the
pending messages object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        new_mid: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">if</span> (options.success || options.error) {
                <span class="hljs-keyword">var</span> mid = _.uniqueId(<span class="hljs-string">'ws-message'</span>);
                <span class="hljs-keyword">this</span>._pending_messages[mid] = options;
                <span class="hljs-keyword">return</span> mid;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        websocket_uri: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> {</span>
            <span class="hljs-keyword">var</span> loc = window.location;
            <span class="hljs-keyword">if</span> (!url) {
                url = loc.href.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];
            }
            <span class="hljs-keyword">if</span> (url.substring(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>) === <span class="hljs-string">'http://'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">'ws://'</span> + url.substring(<span class="hljs-number">7</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url.substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>) === <span class="hljs-string">'https://'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">'wss://'</span> + url.substring(<span class="hljs-number">8</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (url.substring(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>) === <span class="hljs-string">'ws://'</span> || url.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) === <span class="hljs-string">'wss://'</span>) {
                    <span class="hljs-keyword">return</span> url;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> protocol = loc.protocol === <span class="hljs-string">'http:'</span> ? <span class="hljs-string">'ws:'</span> : <span class="hljs-string">'wss:'</span>;
                    <span class="hljs-keyword">return</span> lux.utils.urljoin(protocol, loc.host, loc.pathname, url);
                }
            }
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    register_store(<span class="hljs-string">'ws'</span>, Socket);
    register_store(<span class="hljs-string">'wss'</span>, Socket);</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ALPHABET = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p> Convert a number into a letter representation</p>
<p> num_to_letter(1) == ‘A’
 num_to_letter(2) == ‘B’
 num_to_letter(27) == ‘AA’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.num_to_letter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(num)</span> {</span>
        <span class="hljs-keyword">var</span> len = ALPHABET.length,
            s = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">while</span> (num &gt;= len) {
            <span class="hljs-keyword">var</span> rem = num % len;
            num = <span class="hljs-built_in">Math</span>.floor(num/len);
            s += ALPHABET[rem];
        }
        s += ALPHABET[num];
        <span class="hljs-keyword">return</span> s;
    };

    lux.fields_from_array = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arr)</span> {</span>
        <span class="hljs-keyword">var</span> fields = {};
        _(arr).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(f)</span> {</span>
            <span class="hljs-keyword">var</span> values = fields[f.name];
            <span class="hljs-keyword">if</span> (values === <span class="hljs-literal">undefined</span>) {
                fields[f.name] = f.value;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isArray(values)) {
                values.push(f.value);
            } <span class="hljs-keyword">else</span> {
                fields[f.name] = [values, f.value];
            }
        });
        <span class="hljs-keyword">return</span> fields;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>An object which remember insertion order:</p>
<p> var o = new lux.Ordered();
 o.set(‘foo’, 4);
 o.set(‘bla’, 3);
 o.order === [‘foo’, ‘bla’];</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.Ordered = Class.extend({
        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.all = {};
            <span class="hljs-keyword">this</span>.order = [];
        },
        set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, obj)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.all[key]) {
                <span class="hljs-keyword">this</span>.all[key] = obj;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key) {
                <span class="hljs-keyword">this</span>.order.push(key);
                <span class="hljs-keyword">this</span>.all[key] = obj;
            }
        },
        get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.all[key];
        },
        at: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> {</span>
            <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-keyword">this</span>.order.length) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.all[<span class="hljs-keyword">this</span>.order[index]];
        },
        size: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.order.length;
        },
        each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(iterator, context)</span> {</span>
            _(<span class="hljs-keyword">this</span>.order).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, index)</span> {</span>
                iterator.call(context, <span class="hljs-keyword">this</span>.all[key], key, index);
            }, <span class="hljs-keyword">this</span>);
        },
        ordered: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> all = [];
            _(<span class="hljs-keyword">this</span>.order).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
                all.push(<span class="hljs-keyword">this</span>.all[key]);
            }, <span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">return</span> all;
        }
    });

    <span class="hljs-comment">/** SkipList
    *
    * Task: JavaScript implementation of a skiplist
    *
    * A skiplist is a randomized variant of an ordered linked list with
    * additional, parallel lists.  Parallel lists at higher levels skip
    * geometrically more items.  Searching begins at the highest level, to quickly
    * get to the right part of the list, then uses progressively lower level
    * lists. A new item is added by randomly selecting a level, then inserting it
    * in order in the lists for that and all lower levels. With enough levels,
    * searching is O( log n).
    *
    */</span>
    <span class="hljs-keyword">var</span> SKIPLIST_MAXLEVELS = <span class="hljs-number">32</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SLNode</span><span class="hljs-params">(key, value, next, width)</span> {</span>
        <span class="hljs-keyword">this</span>.key = key;
        <span class="hljs-keyword">this</span>.value = value;
        <span class="hljs-keyword">this</span>.next = next;
        <span class="hljs-keyword">this</span>.width = width;
    }

    <span class="hljs-keyword">var</span> SkipList = lux.SkipList = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(maxLevels, unique)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        maxLevels = <span class="hljs-built_in">Math</span>.min(SKIPLIST_MAXLEVELS,
                <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">8</span>, maxLevels ? maxLevels : SKIPLIST_MAXLEVELS));</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> array = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> {</span>
            <span class="hljs-keyword">var</span> a = [],
                c = maxLevels;
            <span class="hljs-keyword">while</span>(c--) {
                a.push(val);
            }
            <span class="hljs-keyword">return</span> a;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> log2 = <span class="hljs-built_in">Math</span>.log(<span class="hljs-number">2</span>),
            size = <span class="hljs-number">0</span>,
            head = <span class="hljs-keyword">new</span> SLNode(<span class="hljs-string">'HEAD'</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(maxLevels), array(<span class="hljs-number">1</span>)),
            level = <span class="hljs-number">1</span>,
            i;

        <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'length'</span>, {
            get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">return</span> size;
            }
        });

        <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">'levels'</span>, {
            get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">return</span> levels;
            }
        });

        _.extend(<span class="hljs-keyword">this</span>, {
            insert: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value)</span> {</span>
                <span class="hljs-keyword">var</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(maxLevels),
                    rank = array(<span class="hljs-number">0</span>),
                    node = head,
                    prevnode,
                    steps;
                <span class="hljs-keyword">for</span>(i=level-<span class="hljs-number">1</span>; i&gt;=<span class="hljs-number">0</span>; i--) {</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>store rank that is crossed to reach the insert position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    rank[i] = i === level-<span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : rank[i+<span class="hljs-number">1</span>];
                    <span class="hljs-keyword">while</span> (node.next[i] &amp;&amp; node.next[i].key &lt;= key) {
                        rank[i] += node.width[i];
                        node = node.next[i];
                    }
                    chain[i] = node;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>The key already exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (chain[<span class="hljs-number">0</span>].key === key &amp;&amp; unique) {
                    <span class="hljs-keyword">return</span> size;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> lev = <span class="hljs-built_in">Math</span>.min(maxLevels, <span class="hljs-number">1</span> -
                    <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.log(<span class="hljs-built_in">Math</span>.random())/log2));
                <span class="hljs-keyword">if</span> (lev &gt; level) {
                    <span class="hljs-keyword">for</span> (i = level; i &lt; lev; i++) {
                        rank[i] = <span class="hljs-number">0</span>;
                        chain[i] = head;
                        chain[i].width[i] = size;
                    }
                    level = lev;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>create new node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                node = <span class="hljs-keyword">new</span> SLNode(key, value, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(maxLevels),
                    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(maxLevels));
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; lev; i++) {
                    prevnode = chain[i];
                    steps = rank[<span class="hljs-number">0</span>] - rank[i];
                    node.next[i] = prevnode.next[i];
                    node.width[i] = prevnode.width[i] - steps;
                    prevnode.next[i] = node;
                    prevnode.width[i] = steps + <span class="hljs-number">1</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>increment width for untouched levels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> (i = lev; i &lt; level; i++) {
                    chain[i].width[i] += <span class="hljs-number">1</span>;
                }

                size += <span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> size;
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            forEach: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                <span class="hljs-keyword">var</span> node = head.next[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">while</span> (node) {
                    callback(node.value, node.score);
                    node = node.next[<span class="hljs-number">0</span>];
                }
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <h2 id="-dragdrop"> DragDrop</h2>

            </div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>A class for managing HTML5 drag and drop functionality for several
configurations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span>
    DragDrop = lux.DragDrop = lux.Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Default options, overwritten during initialisation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>The css opacity of the dragged element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            opacity: <span class="hljs-number">0.6</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            over_class: <span class="hljs-string">'over'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>This is the <code>drop zone</code>, where dragged elements can be dropped.
It can be a <code>selector</code> string, and <code>HTML Element</code>
or a <code>jQuery</code> element. If not supplied, the whole document is
considered a drop-zone. The dropzone listen for <code>dragenter</code>,
<code>dragover</code>, <code>drop</code> and <code>dragleave</code> events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            dropzone: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>When supplied, the placeholder is added to the DOM when the
drag-enter event is triggered on a dropzone element.
It can be set to true, an Html element or a jQuery element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            placeholder: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>When true a dummy element is added to the dropzone if no
other elements are available.
It can also be a function which return the element to add.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            dummy: <span class="hljs-string">'droppable-dummy'</span>,
            dummy_heigh: <span class="hljs-number">30</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Called on the element being dragged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            onStart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, dd)</span> {</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Called on the element being dragged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            onDrag: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, dd)</span> {</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Called on the target element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            onDrop: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, e, offset, dd)</span> {</span>}
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>The constructor, <code>options</code> is an optional object which overwrites
the <code>defaults</code> parameters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">this</span>.options = options = _.extend({}, <span class="hljs-keyword">this</span>.defaults, options);
            <span class="hljs-keyword">this</span>.candrag = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                dropzone = options.dropzone,
                dummy = options.dummy;</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.placeholder(<span class="hljs-keyword">this</span>.options.placeholder);</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> element = $(document),
                zone = options.dropzone;</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>A Html element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(zone) !== <span class="hljs-string">'string'</span>) {
                element = $(options.dropzone);
                zone = <span class="hljs-literal">null</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dummy) {
                zone += <span class="hljs-string">', .'</span> + dummy;
                <span class="hljs-keyword">this</span>.dummy = $(document.createElement(<span class="hljs-string">'div'</span>))
                                .addClass(dummy).css(<span class="hljs-string">'height'</span>, options.dummy_heigh);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>Drop-zone events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            element.on(<span class="hljs-string">'dragenter'</span>, zone, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.e_dragenter(<span class="hljs-keyword">this</span>, e);
            }).on(<span class="hljs-string">'dragover'</span>, zone, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                e.preventDefault(); <span class="hljs-comment">// Necessary. Allows us to drop.</span>
                self.e_dragover(<span class="hljs-keyword">this</span>, e);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }).on(<span class="hljs-string">'dragleave'</span>, zone, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.e_dragleave(<span class="hljs-keyword">this</span>, e);
            }).on(<span class="hljs-string">'drop'</span>, zone, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.e_drop(<span class="hljs-keyword">this</span>, e);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>set or remove the placeholder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        placeholder: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
            <span class="hljs-keyword">if</span> (value) {
                <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">true</span>) {
                    <span class="hljs-keyword">this</span>._placeholder = $(document.createElement(<span class="hljs-string">'div'</span>));
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>._placeholder = $(value);
                }
                <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                <span class="hljs-keyword">this</span>._placeholder.addClass(<span class="hljs-string">'draggable-placeholder'</span>).unbind(<span class="hljs-string">'dragover'</span>).unbind(<span class="hljs-string">'drop'</span>)
                                 .bind(<span class="hljs-string">'dragover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                                     e.preventDefault();
                                     <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                                 }).bind(<span class="hljs-string">'drop'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                                     self.e_drop(<span class="hljs-keyword">this</span>, e);
                                     <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                                 });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>._placeholder = <span class="hljs-literal">null</span>;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>Enable <code>elem</code> to be dragged and dropped.
<code>handler</code> is an optional handler for dragging.
Both <code>elem</code> and <code>handler</code> can be <code>selector</code> string, in which
case selector-based events are added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        add: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, handle)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                element = $(document),
                selector = elem,
                handle_selector = handle,
                dynamic = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(elem) !== <span class="hljs-string">'string'</span>) {
                element = $(elem).attr(<span class="hljs-string">'draggable'</span>, <span class="hljs-literal">true</span>);
                handle = handle ? $(handle) : element;
                selector = handle_selector = <span class="hljs-literal">null</span>;
                dynamic = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> {
                handle = element;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            handle.on(<span class="hljs-string">'mouseenter'</span>, handle_selector, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                $(<span class="hljs-keyword">this</span>).addClass(<span class="hljs-string">'draggable'</span>);
            }).on(<span class="hljs-string">'mouseleave'</span>, handle_selector, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                $(<span class="hljs-keyword">this</span>).removeClass(<span class="hljs-string">'draggable'</span>);
            }).on(<span class="hljs-string">'mousedown'</span>, handle_selector, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.candrag = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">if</span> (dynamic) elem = $(<span class="hljs-keyword">this</span>).closest(selector).attr(<span class="hljs-string">'draggable'</span>, <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">else</span> elem = element;
                <span class="hljs-keyword">if</span> (!elem.attr(<span class="hljs-string">'id'</span>)) {
                    elem.attr(<span class="hljs-string">'id'</span>, lux.s4());
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            element.on(<span class="hljs-string">'dragstart'</span>, selector, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
                <span class="hljs-keyword">if</span> (self.candrag) {
                    <span class="hljs-keyword">if</span> (self.options.onStart.call(<span class="hljs-keyword">this</span>, e, self) !== <span class="hljs-literal">false</span>) {
                        logger.debug(<span class="hljs-string">'Start dragging '</span> + <span class="hljs-keyword">this</span>.id);
                        <span class="hljs-keyword">return</span> self.e_dragstart(<span class="hljs-keyword">this</span>, e);
                    }
                }
                e.preventDefault();
            }).on(<span class="hljs-string">'dragend'</span>, selector, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                logger.debug(<span class="hljs-string">'Ended dragging '</span> + <span class="hljs-keyword">this</span>.id);
                self.candrag = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> self.e_dragend(<span class="hljs-keyword">this</span>, e);
            }).on(<span class="hljs-string">'drag'</span>, selector, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.options.onDrag.call(<span class="hljs-keyword">this</span>, e, self);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        reposition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, e, offset)</span> {</span>
            <span class="hljs-keyword">var</span> x = e.originalEvent.clientX - offset.left,
                y = e.originalEvent.clientY - offset.top;
            elem.css({<span class="hljs-string">'top'</span>: y, <span class="hljs-string">'left'</span>: x});
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>Utility function for moving an element where another target element is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        moveElement: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, target)</span> {</span>
            elem = $(elem);
            target = $(target);</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>the element is the same, bail out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (elem[<span class="hljs-number">0</span>] === target[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">var</span> parent = elem.parent(),
                target_parent = target.parent();</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>If a placeholder is used, simple replace the placeholder with the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._placeholder) {
                <span class="hljs-keyword">this</span>._placeholder.after(elem).detach();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.move(elem, target, parent, target_parent);
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dummy &amp;&amp; parent[<span class="hljs-number">0</span>] !== target_parent[<span class="hljs-number">0</span>]) {
                <span class="hljs-keyword">if</span> (!parent.children().length) {
                    parent.append(<span class="hljs-keyword">this</span>.dummy);
                }
                <span class="hljs-keyword">if</span> (target_parent.children(<span class="hljs-string">'.'</span> + <span class="hljs-keyword">this</span>.options.dummy).length) {
                    <span class="hljs-keyword">this</span>.dummy.detach();
                }
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Move element to target. If a placeholder is given, the placeholder is moved instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        move: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, target, parent, target_parent, placeholder)</span> {</span>
            <span class="hljs-keyword">if</span> (!placeholder) placeholder = elem;
            <span class="hljs-keyword">if</span> (target.prev().length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>the target has a previous element
check if the parent are the same</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (parent[<span class="hljs-number">0</span>] === target_parent[<span class="hljs-number">0</span>]) {
                    <span class="hljs-keyword">var</span> all = target.nextAll();
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;all.length;i++) {
                        <span class="hljs-keyword">if</span> (all[i] === elem[<span class="hljs-number">0</span>]) {
                            target.before(placeholder);
                            <span class="hljs-keyword">return</span>;
                        }
                    }
                }
                target.after(placeholder);
            } <span class="hljs-keyword">else</span> {
                target.before(placeholder);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        swapElements: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem1, elem2)</span> {</span>
            elem1 = $(elem1);
            elem2 = $(elem2);
            <span class="hljs-keyword">if</span> (elem1[<span class="hljs-number">0</span>] === elem2[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">var</span> next1 = elem1.next(),
                parent1 = elem1.parent(),
                next2 = elem2.next(),
                parent2 = elem2.parent(),
                swap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, next, parent)</span> {</span>
                    <span class="hljs-keyword">if</span> (next.length) {
                        next.before(elem);
                    } <span class="hljs-keyword">else</span> {
                        parent.append(elem);
                    }
                };
            swap(elem2, next1, parent1);
            swap(elem1, next2, parent2);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Start dragging a draggable element
Store the offset between the mouse position and the top,left cornet
of the dragged item.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        e_dragstart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dragged, e)</span> {</span>
            dragged = $(dragged);
            <span class="hljs-keyword">var</span> dataTransfer = e.originalEvent.dataTransfer,
                position = dragged.position(),
                x = e.originalEvent.clientX - position.left,
                y = e.originalEvent.clientY - position.top;
            dataTransfer.effectAllowed = <span class="hljs-string">'move'</span>;
            dataTransfer.setData(<span class="hljs-string">'text/plain'</span>, dragged[<span class="hljs-number">0</span>].id + <span class="hljs-string">','</span> + x + <span class="hljs-string">','</span> + y);
            dragged.fadeTo(<span class="hljs-number">10</span>, <span class="hljs-keyword">this</span>.options.opacity);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._placeholder) {
                <span class="hljs-keyword">var</span> height = <span class="hljs-built_in">Math</span>.min(dragged.height(), <span class="hljs-number">400</span>);
                <span class="hljs-keyword">this</span>._placeholder.height(height);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>End dragging a draggable element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        e_dragend: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dragged, e)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._placeholder) {
                <span class="hljs-keyword">this</span>._placeholder.detach();
            }
            $(dragged).fadeTo(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>Enter drop zone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        e_dragenter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, e)</span> {</span>
            <span class="hljs-keyword">var</span> dataTransfer = e.originalEvent.dataTransfer,
                options = <span class="hljs-keyword">this</span>.options,
                id = dataTransfer.getData(<span class="hljs-string">'text/plain'</span>).split(<span class="hljs-string">','</span>)[<span class="hljs-number">0</span>];
            target = $(target).addClass(options.over_class);
            <span class="hljs-keyword">if</span> (target[<span class="hljs-number">0</span>].id !== id) {
                logger.debug(<span class="hljs-string">'Draggable '</span> + id + <span class="hljs-string">' entering dropzone'</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._placeholder) {
                    <span class="hljs-keyword">var</span> elem = $(<span class="hljs-string">'#'</span> + id);
                    <span class="hljs-keyword">this</span>.move(elem, target, elem.parent(), target.parent(), <span class="hljs-keyword">this</span>._placeholder);
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._placeholder) {
                <span class="hljs-keyword">this</span>._placeholder.detach();
            }
        },
        e_dragover: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, e)</span> {</span>},
        e_dragleave: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, e)</span> {</span>
            $(target).removeClass(<span class="hljs-keyword">this</span>.options.over_class);
        },
        e_drop: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(target, e)</span> {</span>
            e.preventDefault();
            $(target).removeClass(<span class="hljs-keyword">this</span>.options.over_class);
            <span class="hljs-keyword">var</span> dataTransfer = e.originalEvent.dataTransfer,
                idxy = dataTransfer.getData(<span class="hljs-string">'text/plain'</span>).split(<span class="hljs-string">','</span>),
                elem = $(<span class="hljs-string">'#'</span>+idxy[<span class="hljs-number">0</span>]),
                xy = {
                    left: <span class="hljs-built_in">parseInt</span>(idxy[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>),
                    top: <span class="hljs-built_in">parseInt</span>(idxy[<span class="hljs-number">2</span>], <span class="hljs-number">10</span>)
                };
            <span class="hljs-keyword">if</span> (elem.length) {
                logger.info(<span class="hljs-string">'Dropping '</span> + elem.attr(<span class="hljs-string">'id'</span>));
                <span class="hljs-keyword">this</span>.options.onDrop.call(target, elem, e, xy, <span class="hljs-keyword">this</span>);
            }
        }
    });

    <span class="hljs-keyword">var</span> icons = lux.icons = {</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        fontawesome: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, options)</span> {</span>
            <span class="hljs-keyword">var</span> i = $(<span class="hljs-string">'i'</span>, elem).remove(),
                ni = <span class="hljs-string">'&lt;i class="fa fa-'</span> + options.icon + <span class="hljs-string">'"&gt;&lt;/i&gt;'</span>;
            <span class="hljs-keyword">if</span> (elem[<span class="hljs-number">0</span>].text) {
                elem[<span class="hljs-number">0</span>].text = <span class="hljs-string">' '</span> + elem[<span class="hljs-number">0</span>].text;
            }
            elem.prepend(ni);
        }
    };

    lux.addIcon = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, options)</span> {</span>
        <span class="hljs-keyword">var</span> p = lux.icons[lux.icon];
        <span class="hljs-keyword">if</span> (p &amp;&amp; !elem.is(<span class="hljs-string">'html'</span>)) {
            <span class="hljs-keyword">if</span> (!options) options = elem.data();
            <span class="hljs-keyword">if</span> (options.icon) p(elem, options);
        }
    };

    lux.autoViews.push({
        selector: <span class="hljs-string">'[data-icon]'</span>,
        load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem)</span> {</span>
            lux.addIcon($(elem));
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <h2 id="-ajax-links-buttons"> Ajax Links &amp; buttons</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.ajaxResponses = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.ajaxResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o, code, jqXHR)</span> {</span>
        _(lux.ajaxResponses).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(response)</span> {</span>
            <span class="hljs-keyword">return</span> response(o, jqXHR);
        });
    };

    lux.ajaxElement = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
        <span class="hljs-keyword">var</span> url = elem.is(<span class="hljs-string">'a'</span>) ? elem.attr(<span class="hljs-string">'href'</span>) : elem.data(<span class="hljs-string">'href'</span>),
            options = {
                type: elem.data(<span class="hljs-string">'action'</span>) || <span class="hljs-string">'get'</span>,

                success: lux.ajaxResponse
            };
        elem.click(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
            e.preventDefault();
            $.ajax(url, options);
        });
    };

    lux.autoViews.push({
        selector: <span class="hljs-string">'[data-ajax="true"]'</span>,
        load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem)</span> {</span>
            lux.ajaxElement($(elem));
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.ajaxResponses.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o, status, jqXHR)</span> {</span>
        <span class="hljs-keyword">if</span> (o.redirect) {
            window.location = o.redirect;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.ajaxResponses.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(o, status, jqXHR)</span> {</span>
        <span class="hljs-keyword">if</span> (o.html) {
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <h2 id="-buttons"> Buttons</h2>
<p> A view for diplaying buttons
 Usage:</p>
<pre><code> <span class="hljs-keyword">var</span> btn1 = <span class="hljs-keyword">new</span> Button({text: <span class="hljs-string">'Hi!'</span>});
 <span class="hljs-keyword">var</span> btn2 = <span class="hljs-keyword">new</span> Button({text: <span class="hljs-string">'submit'</span>, icon: <span class="hljs-string">'fire'</span>});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    BUTTON_SIZES = [<span class="hljs-string">'large'</span>, <span class="hljs-string">'normal'</span>, <span class="hljs-string">'small'</span>, <span class="hljs-string">'mini'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    buttonGroup = lux.buttonGroup = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
        options || (options = {});
        <span class="hljs-keyword">var</span> elem = $(document.createElement(<span class="hljs-string">'div'</span>));
        <span class="hljs-keyword">if</span> (options.vertical) elem.addClass(<span class="hljs-string">'btn-group-vertical'</span>);
        <span class="hljs-keyword">else</span> elem.addClass(<span class="hljs-string">'btn-group'</span>);
        <span class="hljs-keyword">if</span> (options.radio) {
            elem.data(<span class="hljs-string">'toggle'</span>, <span class="hljs-string">'buttons-radio'</span>);
        }
        <span class="hljs-keyword">return</span> elem;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    Button = lux.Button = lux.createView(<span class="hljs-string">'button'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        tagName: <span class="hljs-string">'button'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        selector: <span class="hljs-string">'.btn'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {
            skin: <span class="hljs-string">'default'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        className: <span class="hljs-string">'btn'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> btn = <span class="hljs-keyword">this</span>.elem;
            btn.addClass(<span class="hljs-keyword">this</span>.className).attr({
                type: options.type,
                title: options.title,
                href: options.href,
            }).addClass(options.classes);</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.setSkin(options.skin);
            <span class="hljs-keyword">this</span>.setSize(options.size);
            <span class="hljs-keyword">if</span> (options.text) btn.html(options.text);
            <span class="hljs-keyword">if</span> (options.icon) lux.addIcon(btn, options);
            <span class="hljs-keyword">if</span> (options.block) btn.addClass(<span class="hljs-string">'btn-block'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        setSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(size)</span> {</span>
            <span class="hljs-keyword">if</span>(BUTTON_SIZES.indexOf(size) &gt; -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> elem = <span class="hljs-keyword">this</span>.elem,
                    prefix = <span class="hljs-keyword">this</span>.className + <span class="hljs-string">'-'</span>;
                _(BUTTON_SIZES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(size)</span> {</span>
                    elem.removeClass(prefix + size);
                });
                elem.addClass(prefix + size);
            }
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <h2 id="-form-view"> Form view</h2>
<p> Javascript view for forms and form fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    globalAttributes = [<span class="hljs-string">'title'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    noControlClass = [<span class="hljs-string">'checkbox'</span>, <span class="hljs-string">'radio'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    controlClass = <span class="hljs-string">'form-control'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    Form = lux.Form = lux.createView(<span class="hljs-string">'form'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        selector: <span class="hljs-string">'form:data(lux)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        tagName: <span class="hljs-string">'form'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {
            dataType: <span class="hljs-string">"json"</span>,
            layout: <span class="hljs-literal">null</span>,
            ajax: <span class="hljs-literal">false</span>,
            complete: <span class="hljs-literal">null</span>,
            error: <span class="hljs-literal">null</span>,
            success: lux.ajaxResponse
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.elem.hasClass(<span class="hljs-string">'horizontal'</span>)) {
                options.layout = <span class="hljs-string">'horizontal'</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.elem.hasClass(<span class="hljs-string">'inline'</span>)) {
                options.layout = <span class="hljs-string">'inline'</span>;
            }
            <span class="hljs-keyword">if</span> (options.layout) {
                <span class="hljs-keyword">this</span>.layout = options.layout;
                <span class="hljs-keyword">this</span>.elem.addClass(<span class="hljs-string">'form-'</span> + <span class="hljs-keyword">this</span>.layout);
            }
            <span class="hljs-keyword">if</span> (options.ajax || <span class="hljs-keyword">this</span>.elem.hasClass(<span class="hljs-string">'ajax'</span>)) {
                <span class="hljs-keyword">this</span>.ajax(options);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>Apply the <code>jquery-form</code> ajax plugin to this form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ajax: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> elem = <span class="hljs-keyword">this</span>.elem;
            <span class="hljs-built_in">require</span>([<span class="hljs-string">'jquery-form'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                elem.ajaxForm(options);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>Add a list of <code>Fields</code> to this form.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addFields: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fields, options)</span> {</span>
            <span class="hljs-keyword">var</span> processed = [],
                self = <span class="hljs-keyword">this</span>,
                elem,
                fieldset;</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _(fields).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> {</span>
                <span class="hljs-keyword">if</span> (field &amp;&amp; field.name &amp;&amp; processed.indexOf(field.name) === -<span class="hljs-number">1</span>) {
                    processed.push(field.name);
                    field.render(self, options);
                }
            });
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>Add a submit button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addSubmit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">if</span> (!options.tagName) {
                options.tagName = <span class="hljs-string">'button'</span>;
                <span class="hljs-keyword">if</span> (!options.text) options.text = <span class="hljs-string">'Submit'</span>;
            }
            <span class="hljs-keyword">var</span> btn = <span class="hljs-keyword">new</span> Button(options);
            <span class="hljs-keyword">this</span>.fieldset(options.fieldset).append(btn.elem);
            <span class="hljs-keyword">return</span> btn;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.layout) {
                <span class="hljs-keyword">var</span> layout = <span class="hljs-keyword">this</span>[<span class="hljs-string">'render_'</span> + <span class="hljs-keyword">this</span>.layout];
                layout.call(<span class="hljs-keyword">this</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
                $(<span class="hljs-string">'input,select,textarea'</span>, <span class="hljs-keyword">this</span>.elem).each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> elem = $(<span class="hljs-keyword">this</span>);
                    <span class="hljs-keyword">if</span> (noControlClass.indexOf(elem.attr(<span class="hljs-string">'type'</span>)) === -<span class="hljs-number">1</span>)
                        elem.addClass(controlClass);
                });
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        render_inline: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            $(<span class="hljs-string">'input,select'</span>, <span class="hljs-keyword">this</span>.elem).each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">var</span> elem = $(<span class="hljs-keyword">this</span>);
                <span class="hljs-keyword">if</span> (noControlClass.indexOf(elem.attr(<span class="hljs-string">'type'</span>)) === -<span class="hljs-number">1</span>) {
                    elem.parent().find(<span class="hljs-string">'label'</span>).addClass(<span class="hljs-string">'sr-only'</span>);
                    elem.addClass(controlClass);
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        render_horizontal: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                elem, label, parent, wrap, group;
            $(<span class="hljs-string">'input,select'</span>, <span class="hljs-keyword">this</span>.elem).each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                elem = $(<span class="hljs-keyword">this</span>).addClass(controlClass);
                wrap = elem.closest(self.groupClass);
                <span class="hljs-keyword">if</span> (wrap.length) {
                    parent = elem.parent();
                    <span class="hljs-keyword">if</span> (!parent.is(<span class="hljs-string">'label'</span>)) parent = elem;
                    wrap = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-string">'controls'</span>);
                    parent.before(wrap).appendTo(wrap);
                    group = wrap.parent();
                    <span class="hljs-keyword">if</span> (!wrap.hasClass(<span class="hljs-string">'control-group'</span>)) {
                        label = wrap.prev();
                        group = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-string">'control-group'</span>);
                        wrap.before(group).appendTo(group);
                        <span class="hljs-keyword">if</span> (label.is(<span class="hljs-string">'label'</span>)) {
                            group.prepend(label.addClass(<span class="hljs-string">'control-label'</span>));
                        }
                    }
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p> Get a fieldset from the form if possible</p>
<p> If <code>fieldset_selector</code> is not specified or a fieldset is not found
 return the form element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fieldset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldset_selector)</span> {</span>
            <span class="hljs-keyword">if</span> (!fieldset_selector) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.elem;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fieldset_selector <span class="hljs-keyword">instanceof</span> jQuery) {
                <span class="hljs-keyword">return</span> fieldset_selector;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fieldset_selector <span class="hljs-keyword">instanceof</span> HTMLElement) {
                <span class="hljs-keyword">return</span> $(fieldset_selector);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> elem = <span class="hljs-keyword">this</span>.elem.find(fieldset_selector);
                <span class="hljs-keyword">if</span> (!elem.length) elem = <span class="hljs-keyword">this</span>.elem.find(<span class="hljs-string">'.'</span>+fieldset_selector);
                <span class="hljs-keyword">return</span> elem.length ? elem : <span class="hljs-keyword">this</span>.elem;
            }
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p> Base class for <code>Form</code> fields</p>
<ul>
<li><code>label</code>, if set to <code>false</code> no label is displaied</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Field = lux.Field = lux.Class.extend({
        fieldOptions: [
            <span class="hljs-string">'tagName'</span>, <span class="hljs-string">'type'</span>, <span class="hljs-string">'label'</span>, <span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'fieldset'</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        attributes: _.union([
            <span class="hljs-string">'accept'</span>, <span class="hljs-string">'alt'</span>, <span class="hljs-string">'autocomplete'</span>, <span class="hljs-string">'autofocus'</span>, <span class="hljs-string">'disabled'</span>,
            <span class="hljs-string">'form'</span>, <span class="hljs-string">'formaction'</span>, <span class="hljs-string">'readonly'</span>, <span class="hljs-string">'required'</span>], globalAttributes),</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        formGroup: <span class="hljs-string">'form-group'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        tagName: <span class="hljs-string">'input'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        type: <span class="hljs-string">'text'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, options)</span> {</span>
            options || (options = {});
            <span class="hljs-keyword">this</span>.name = name;
            _.extend(<span class="hljs-keyword">this</span>, _.pick(options, <span class="hljs-keyword">this</span>.fieldOptions));
            <span class="hljs-keyword">this</span>.attributes = _.pick(options, <span class="hljs-keyword">this</span>.attributes);
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.attributes.title) <span class="hljs-keyword">this</span>.attributes.title = <span class="hljs-keyword">this</span>.name;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.label !== <span class="hljs-literal">false</span>)
                <span class="hljs-keyword">this</span>.label = <span class="hljs-keyword">this</span>.getLabel();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.required) <span class="hljs-keyword">this</span>.required = <span class="hljs-string">'required'</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, value)</span> {</span>
            <span class="hljs-keyword">if</span> (value || value === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> value + <span class="hljs-string">''</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        setValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, elem)</span> {</span>
            <span class="hljs-keyword">if</span> (model) elem.val(model.get(<span class="hljs-keyword">this</span>.name));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>Render this field for the <code>form</code>.
Return a jQuery element which can be included in the <code>form</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(form, options)</span> {</span>
            <span class="hljs-keyword">var</span>
            elem = $(document.createElement(<span class="hljs-keyword">this</span>.tagName)).attr(
                <span class="hljs-keyword">this</span>.attributes),
            placeholder = <span class="hljs-keyword">this</span>.getPlaceholder();
            elem.attr(<span class="hljs-string">'name'</span>, <span class="hljs-keyword">this</span>.name);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tagName === <span class="hljs-string">'input'</span>)
                elem.attr(<span class="hljs-string">'type'</span>, <span class="hljs-keyword">this</span>.type);
            <span class="hljs-keyword">var</span> type = elem.attr(<span class="hljs-string">'type'</span>);
            <span class="hljs-keyword">if</span> (noControlClass.indexOf(type) === -<span class="hljs-number">1</span>)
                elem.addClass(controlClass);</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (placeholder)
                elem.attr(<span class="hljs-string">'placeholder'</span>, placeholder);
            <span class="hljs-keyword">if</span> (_.isFunction(form)) form(elem);
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.setValue(form.model, elem);
                <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'hidden'</span>)
                    elem = <span class="hljs-keyword">this</span>.outerContainer(elem, form);
                form.fieldset(<span class="hljs-keyword">this</span>.fieldset).append(elem);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        getPlaceholder: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.placeholder !== <span class="hljs-literal">false</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.placeholder ? <span class="hljs-keyword">this</span>.placeholder : <span class="hljs-keyword">this</span>.getLabel();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        getLabel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.label || lux.niceStr(<span class="hljs-keyword">this</span>.name);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>Wrap field and label with an outer container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        outerContainer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, form)</span> {</span>
            <span class="hljs-keyword">var</span> outer = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-keyword">this</span>.formGroup);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.label) {
                <span class="hljs-keyword">var</span> id = elem.attr(<span class="hljs-string">'id'</span>);
                <span class="hljs-keyword">if</span> (!id) {
                    id = _.uniqueId(<span class="hljs-string">'field'</span>);
                    elem.attr(<span class="hljs-string">'id'</span>, id);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                $(document.createElement(<span class="hljs-string">'label'</span>)).html(<span class="hljs-keyword">this</span>.label
                    ).attr(<span class="hljs-string">'for'</span>, id).appendTo(outer);
            }
            <span class="hljs-keyword">return</span> outer.append(elem);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    IntegerField = lux.Field = Field.extend({
        type: <span class="hljs-string">'number'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, value)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    FloatField = lux.FloatField = Field.extend({
        type: <span class="hljs-string">'number'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, value)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(value);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    BooleanField = lux.BooleanField = Field.extend({
        type: <span class="hljs-string">'checkbox'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        controlClass: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        setValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, elem)</span> {</span>
            <span class="hljs-keyword">if</span> (model) {
                <span class="hljs-keyword">var</span> val = model.get(<span class="hljs-keyword">this</span>.name) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                elem.prop(<span class="hljs-string">'checked'</span>, val);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, value)</span> {</span>
            <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>)
                <span class="hljs-keyword">return</span> value === <span class="hljs-literal">true</span> || value === <span class="hljs-string">'on'</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        outerContainer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem, form)</span> {</span>
            <span class="hljs-keyword">var</span> label = $(document.createElement(<span class="hljs-string">'label'</span>)),
                outer = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-string">'checkbox'</span>);
            elem = outer.append(label.append(elem).append(<span class="hljs-keyword">this</span>.label));
            form.fieldset(<span class="hljs-keyword">this</span>.fieldset).append(elem);
            <span class="hljs-keyword">return</span> elem;
        },
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p>A <code>ChoiceField</code> is by default rendered as a <code>select</code> element.</p>
<p> A <code>select2</code> object or function can be passed during construction.
 In this case the <code>select2</code> jQuery plugin is applied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ChoiceField = lux.ChoiceField = Field.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p>If the <code>select</code> dictionary is passed and the <code>tagName</code> is <code>select</code>
the jQuery select plugin is applied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fieldOptions: _.union(
            Field.prototype.fieldOptions,
            [<span class="hljs-string">'choices'</span>, <span class="hljs-string">'select2'</span>]),</pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        tagName: <span class="hljs-string">'select'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        type: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        setValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model, elem)</span> {</span>
            <span class="hljs-keyword">if</span> (model) {
                <span class="hljs-keyword">var</span> val = model.get(<span class="hljs-keyword">this</span>.name);
                <span class="hljs-keyword">if</span> (elem.is(<span class="hljs-string">'select'</span>)) {
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elem.val() === val) {
                    elem.prop(<span class="hljs-string">'checked'</span>, <span class="hljs-literal">true</span>);
                }
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p> Render this <code>ChoiceField</code> into <code>form</code></p>
<p> <code>form</code> can be a <code>Form</code> instance or a function accepting the
 new jQuery element created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(form)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                choices= <span class="hljs-keyword">this</span>.choices,
                elem, text;
            <span class="hljs-keyword">if</span> (_.isFunction(choices)) choices = choices(form);</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p>Select element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tagName === <span class="hljs-string">'select'</span>) {
                elem = $(document.createElement(<span class="hljs-keyword">this</span>.tagName)).attr({
                    name: <span class="hljs-keyword">this</span>.name
                }).append($(<span class="hljs-string">"&lt;option&gt;&lt;/option&gt;"</span>)).addClass(controlClass);</pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                _(choices).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> {</span>
                    <span class="hljs-keyword">if</span> (!(val <span class="hljs-keyword">instanceof</span> jQuery)) {
                        <span class="hljs-keyword">if</span> (_.isString(val)) text = val;
                        <span class="hljs-keyword">else</span> {
                            text = val.text || val.value;
                            val = val.value;
                        }
                        val = $(<span class="hljs-string">"&lt;option&gt;&lt;/option&gt;"</span>).val(val).text(text);
                    }
                    elem.append(val);
                });
                <span class="hljs-keyword">if</span> (_.isFunction(form)) form(elem);
                <span class="hljs-keyword">else</span> {
                    self.setValue(form.model, elem);
                    form.fieldset(<span class="hljs-keyword">this</span>.fieldset).append(
                        self.outerContainer(elem, form));
                }
                <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">this</span>.select2;
                <span class="hljs-keyword">if</span> (_.isFunction(opts)) opts = opts(form);
                <span class="hljs-keyword">if</span> (opts) {
                    <span class="hljs-keyword">if</span> (!opts.placeholder) opts.placeholder = <span class="hljs-keyword">this</span>.getPlaceholder();
                    elem.Select(opts);
                }
                <span class="hljs-keyword">return</span> elem;</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p>Radio element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tagName === <span class="hljs-string">'input'</span> &amp;&amp; <span class="hljs-keyword">this</span>.type === <span class="hljs-string">'radio'</span>) {
                _(choices).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> {</span>
                    <span class="hljs-keyword">if</span> (val <span class="hljs-keyword">instanceof</span> string) text = val;
                    <span class="hljs-keyword">else</span> {
                        text = val.text || val.value;
                        val = val.value;
                    }
                    elem = $(document.createElement(<span class="hljs-keyword">this</span>.tagName)).attr({
                        type: <span class="hljs-string">'radio'</span>,
                        name: self.name,
                        value: val
                    }).html(text);
                    self.setValue(form.model, elem);
                });
                form.elem.append(elem);
            }
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    MultiField = lux.MultiField = ChoiceField.extend({

        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(form)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tagName === <span class="hljs-string">'select'</span>) {
                <span class="hljs-keyword">var</span> elem = <span class="hljs-keyword">this</span>._super(form);
                <span class="hljs-keyword">return</span> elem;
            }
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    TextArea = lux.TextArea = Field.extend({
        tagName: <span class="hljs-string">'textarea'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        formGroup: <span class="hljs-string">'textarea'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        attributes: _.union(
            Field.prototype.attributes,
            [<span class="hljs-string">'rows'</span>, <span class="hljs-string">'cols'</span>])
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    KeywordsField = lux.KeywordsField = Field.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance, value)</span> {</span>
            <span class="hljs-keyword">if</span> (_.isString(value)) {
                <span class="hljs-keyword">var</span> result = [];
                _(value.split(<span class="hljs-string">','</span>)).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
                    el = el.trim();
                    <span class="hljs-keyword">if</span> (el) {
                        result.push(el);
                    }
                });
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!_.isArray(value)) {
                <span class="hljs-keyword">var</span> val = [];
                _(value).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
                    val.push(v);
                });
                <span class="hljs-keyword">return</span> val;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> value;
            }
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <h2 id="-select2-utilities"> Select2 utilities</h2>
<p> A proxy for select2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.fn.Select = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
        options || (options = {});
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
        <span class="hljs-built_in">require</span>([<span class="hljs-string">'select'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <p>if (_.isObject(options)) options.width = ‘element’;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.select2(options);
        });
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p>Select2 hook for lux set_value_hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> get_select2_value = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(element, value)</span> {</span>
        <span class="hljs-keyword">if</span> (element.hasClass(<span class="hljs-string">'select2-offscreen'</span>)) {
            element.select2(<span class="hljs-string">'val'</span>, value);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.set_value_hooks.push(get_select2_value);</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p> A view for displaying grids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span></pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    GridRow = lux.createView(<span class="hljs-string">'gridrow'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>.elem.addClass(<span class="hljs-string">'row'</span>).addClass(<span class="hljs-string">'grid24'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _(options.columns).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(col)</span> {</span>
                <span class="hljs-keyword">var</span> size = <span class="hljs-string">'span'</span> + col;
                self.elem.append($(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                    <span class="hljs-string">'column'</span>).addClass(size));
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        column: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> {</span>
            index = index || <span class="hljs-number">0</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.elem.children().eq(index);
        }
    }),</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>    Grid = lux.Grid = lux.createView(<span class="hljs-string">'grid'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {
            type: <span class="hljs-string">'fluid'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">this</span>.elem.addClass(<span class="hljs-string">'grid'</span>).addClass(options.type);

            <span class="hljs-keyword">if</span> (options.rows) {
                _(options.rows).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(row)</span> {</span>
                    self.addRow(row);
                });
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        addRow: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(columns)</span> {</span>
            <span class="hljs-keyword">var</span> row = <span class="hljs-keyword">new</span> GridRow({<span class="hljs-string">'columns'</span>: columns});
            row.elem.appendTo(<span class="hljs-keyword">this</span>.elem);
            <span class="hljs-keyword">return</span> row;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        row: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> {</span>
            index = index || <span class="hljs-number">0</span>;
            <span class="hljs-keyword">return</span> GridRow.getInstance(<span class="hljs-keyword">this</span>.elem.children().eq(index));
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p>Add full-screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> Fullscreen = lux.Fullscreen = lux.createView(<span class="hljs-string">'fullscreen'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {
            zindex: <span class="hljs-number">2010</span>,
            icon: <span class="hljs-string">'times-circle'</span>,
            themes: [<span class="hljs-string">'default'</span>, <span class="hljs-string">'inverse'</span>]
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> container = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                    <span class="hljs-string">'fullscreen'</span>).css({<span class="hljs-string">'z-index'</span>: options.zindex});

            <span class="hljs-keyword">this</span>.wrap = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                <span class="hljs-string">'fullscreen-container'</span>).appendTo(container);
            <span class="hljs-keyword">this</span>.side = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                <span class="hljs-string">'fullscreen-sidebar'</span>).appendTo(container);
            <span class="hljs-keyword">this</span>.sidebar = buttonGroup({vertical: <span class="hljs-literal">true</span>}).appendTo(<span class="hljs-keyword">this</span>.side);</pre></div></div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.themes = options.themes;
            <span class="hljs-keyword">this</span>.theme = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.exit = <span class="hljs-keyword">new</span> Button({
                icon: options.icon,
                title: <span class="hljs-string">'Exit full screen'</span>
            });
            <span class="hljs-keyword">this</span>.exit.elem.appendTo(<span class="hljs-keyword">this</span>.sidebar);
            <span class="hljs-keyword">this</span>.theme_button = <span class="hljs-keyword">new</span> Button({
                icon: <span class="hljs-string">'laptop'</span>,
                title: <span class="hljs-string">'theme'</span>
            });
            <span class="hljs-keyword">this</span>.theme_button.elem.appendTo(<span class="hljs-keyword">this</span>.sidebar);</pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._wrapped = {
                elem: <span class="hljs-keyword">this</span>.elem,
                previous: <span class="hljs-keyword">this</span>.elem.prev(),
                parent: <span class="hljs-keyword">this</span>.elem.parent()
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.setElement(container);
            <span class="hljs-keyword">this</span>.toggle_skin();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">if</span> (!self.elem.parent().length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                self.exit.elem.click(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    self.remove();
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                self.theme_button.elem.click(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    self.toggle_skin();
                });
                self.wrap.append(<span class="hljs-keyword">this</span>._wrapped.elem);
                self.elem.appendTo(document.body);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        remove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> w = <span class="hljs-keyword">this</span>._wrapped;
            <span class="hljs-keyword">if</span>(w.previous.length) {
                w.previous.after(w.elem);
            } <span class="hljs-keyword">else</span> {
                w.parent.prepend(w.elem);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._super();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        toggle_skin: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> themes = <span class="hljs-keyword">this</span>.themes,
                old_theme = <span class="hljs-keyword">this</span>.theme;
            <span class="hljs-keyword">this</span>.theme = old_theme ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;
            <span class="hljs-keyword">this</span>.theme_button.setSkin(themes[old_theme]);
            <span class="hljs-keyword">this</span>.setSkin(themes[<span class="hljs-keyword">this</span>.theme]);
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <h2 id="-dialog"> Dialog</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> Dialog = lux.Dialog = lux.createView(<span class="hljs-string">'dialog'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        jQuery: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        selector: <span class="hljs-string">'.dialog'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaultElement: <span class="hljs-string">'div'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        default_modals: {
            backdrop: <span class="hljs-literal">true</span>,
            keyboard: <span class="hljs-literal">true</span>,
            width: <span class="hljs-number">400</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        defaults: {</pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p>Specialised class name for this dialog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            className: <span class="hljs-literal">null</span>,
            show: <span class="hljs-literal">true</span>,
            keyboard: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p>Can the dialog be closed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            closable: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p>Can the dialog be collapsable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            collapsable: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p>If <code>collapsable</code> is <code>true</code>, this parameter controls how the
dialog is rendered the first time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            collapsed: <span class="hljs-literal">false</span>,
            dragdrop: <span class="hljs-literal">false</span>,
            fullscreen: <span class="hljs-literal">false</span>,
            title: <span class="hljs-literal">null</span>,
            body: <span class="hljs-literal">null</span>,
            footer: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p>To create a modal dialog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            modal: <span class="hljs-literal">false</span>,
            autoOpen: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <p>Default width</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            width: <span class="hljs-literal">null</span>,
            height: <span class="hljs-literal">null</span>,
            top: <span class="hljs-literal">null</span>,
            skin: <span class="hljs-string">'default'</span>,
            icons: {
                open: <span class="hljs-string">'plus-circle'</span>,
                close: <span class="hljs-string">'minus-circle'</span>,
                remove: <span class="hljs-string">'times'</span>,
                fullscreen: <span class="hljs-string">'arrows-alt'</span>
            },
            buttons: {
                size: <span class="hljs-string">'mini'</span>
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <p>Create the dialog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialise: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                elem = <span class="hljs-keyword">this</span>.elem.addClass(<span class="hljs-string">'dialog'</span>).addClass(
                    options.className).hide(),
                closable = options.closable,
                title = elem.attr(<span class="hljs-string">'title'</span>) || options.title,
                header = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-string">'header'</span>),
                wrap = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(<span class="hljs-string">'body-wrap'</span>),
                h3 = $(document.createElement(<span class="hljs-string">'h3'</span>)),
                toggle;</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.setSkin(options.skin);</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._body = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                <span class="hljs-string">'body'</span>).append(elem.contents());
            <span class="hljs-keyword">this</span>._foot = <span class="hljs-literal">null</span>;
            self.buttons = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                <span class="hljs-string">'btn-group'</span>).addClass(<span class="hljs-string">'pull-right'</span>);
            header.append(self.buttons).append(h3);
            <span class="hljs-keyword">if</span> (title) {
                h3.append(title);
            }
            elem.empty().append(header).append(wrap.append(<span class="hljs-keyword">this</span>._body));
            <span class="hljs-keyword">if</span> (options.body) {
                <span class="hljs-keyword">this</span>._body.append(options.body);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.createButton = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(opts)</span> {</span>
                opts = _.extend(opts || {}, options.buttons);
                <span class="hljs-keyword">if</span> (!opts.skin) opts.skin = <span class="hljs-keyword">this</span>.getSkin();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Button(opts);
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <p>Add additional options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (options.modal) self._addModal(options);
            <span class="hljs-keyword">if</span> (options.width) elem.width(options.width);
            <span class="hljs-keyword">if</span> (options.height) <span class="hljs-keyword">this</span>._body.height(options.height);
            <span class="hljs-keyword">if</span> (options.collapsable) self._addCollapsable(options);
            <span class="hljs-keyword">if</span> (options.closable) <span class="hljs-keyword">this</span>._addClosable(options);
            <span class="hljs-keyword">if</span> (options.fullscreen) <span class="hljs-keyword">this</span>._addFullscreen(options);
            <span class="hljs-keyword">if</span> (options.movable) <span class="hljs-keyword">this</span>._addMovable(options);
            <span class="hljs-keyword">if</span> (options.autoOpen) self.render();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        body: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._body;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        foot: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._foot;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        header: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.elem.children(<span class="hljs-string">'.header'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        title: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.header().children(<span class="hljs-string">'h3'</span>).html(value);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        render: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.fadeIn();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <p> INTERNALS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _addModal: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span>
            self = <span class="hljs-keyword">this</span>,
            opts = _.extend({}, self.default_modals,
                _.isObject(options.modal) ? options.modal : <span class="hljs-literal">null</span>),
            modal = $(document.createElement(<span class="hljs-string">'div'</span>)).attr({
                tabindex: -<span class="hljs-number">1</span>,
                role: <span class="hljs-string">'dialog'</span>
            }).addClass(<span class="hljs-string">'modal fullscreen'</span>).hide().appendTo(document.body),
            backdrop = $(document.createElement(<span class="hljs-string">'div'</span>)).addClass(
                <span class="hljs-string">'modal-backdrop fullscreen'</span>),
            ename = <span class="hljs-keyword">this</span>.eventName(<span class="hljs-string">'click'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            modal.on(ename, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                self.fadeOut();
            });
            <span class="hljs-keyword">this</span>.elem.off(ename).on(ename, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                e.stopPropagation();
            });
            <span class="hljs-keyword">if</span> (opts.keyboard) {
                ename = <span class="hljs-keyword">this</span>.eventName(<span class="hljs-string">'keyup'</span>);
                modal.off(ename).on(ename, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                    e.which === <span class="hljs-number">27</span> &amp;&amp; self.fadeOut();
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.enforceFocus();
            options.collapsable = <span class="hljs-literal">false</span>;
            options.width = options.width || opts.width;
            options.closable = options.closable === <span class="hljs-literal">null</span> ? <span class="hljs-literal">true</span> : options.closable;
            <span class="hljs-keyword">this</span>.elem.appendTo(modal).addClass(<span class="hljs-string">'dialog-modal'</span>)
            .on(<span class="hljs-string">'remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                backdrop.remove();
                modal.remove();
            }).on(<span class="hljs-string">'show'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (opts.backdrop)
                    backdrop.appendTo(document.body);
                modal.show();
                $(document.body).addClass(<span class="hljs-string">'modal-open'</span>);
            }).on(<span class="hljs-string">'hide'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                modal.hide();
                backdrop.detach();
                $(document.body).removeClass(<span class="hljs-string">'modal-open'</span>);
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p>make the dialog closable, unless it is already closable.
The optional <code>options</code>  can specify:</p>

            </div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <ul>
<li><code>destroy</code>, if true the dialog is removed when
closed otherwise it is just fadeOut. Default <code>True</code>.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _addClosable: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span>
            destroy = options.destroy,
            self = <span class="hljs-keyword">this</span>,
            close = <span class="hljs-keyword">this</span>.createButton({
                icon: options.icons.remove
            });
            close.elem.appendTo(<span class="hljs-keyword">this</span>.buttons).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                self.fadeOut({
                    complete: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        destroy ? self.destroy() : self.hide();
                    }
                });
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p>Make this dialog collapsable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _addCollapsable: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                body = <span class="hljs-keyword">this</span>.elem.children(<span class="hljs-string">'.body-wrap'</span>),
                button = self.createButton(),
                hidden = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>If the dialog starts life as already collapsed, avoid to show
the transaction by hiding the body. This requires a little trick
which involve removing the <code>collapse</code> class when the <code>hide</code> event
is triggered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (options.collapsed) {
                hidden = <span class="hljs-literal">true</span>;
                body.hide().addClass(<span class="hljs-string">'in'</span>).one(<span class="hljs-string">'hide'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    body.removeClass(<span class="hljs-string">'collapse'</span>);
                });
            }
            body.on(<span class="hljs-string">'show'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (hidden) {
                    hidden = <span class="hljs-literal">false</span>;
                    body.addClass(<span class="hljs-string">'collapse'</span>).show();
                }
                self.elem.removeClass(<span class="hljs-string">'collapsed'</span>);
                lux.addIcon(button.elem, {icon: options.icons.close});
            }).on(<span class="hljs-string">'hidden'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                self.elem.addClass(<span class="hljs-string">'collapsed'</span>);
                lux.addIcon(button.elem, {icon: options.icons.open});
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p>make sure height is auto when the dialog is not collapsed at startupSSSSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!options.collapsed) {
                body.height(<span class="hljs-string">'auto'</span>);
            }
            button.elem.appendTo(<span class="hljs-keyword">this</span>.buttons).mousedown(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
                e.stopPropagation();
            }).click(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                body.collapse(<span class="hljs-string">'toggle'</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            });
            <span class="hljs-built_in">require</span>([<span class="hljs-string">'bootstrap'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                self.elem.children(<span class="hljs-string">'.body-wrap'</span>).collapse();
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p>Add full screen button and action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _addFullscreen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
            <span class="hljs-keyword">var</span>
            fullscreen = options.fullscreen,
            button = <span class="hljs-keyword">this</span>.createButton({
                icon: options.icons.fullscreen,
                title: <span class="hljs-string">'Full screen mode'</span>
            });
            <span class="hljs-keyword">if</span> (!fullscreen.render) {</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p>default full screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                fullscreen = <span class="hljs-keyword">new</span> Fullscreen({elem: <span class="hljs-keyword">this</span>.body()});
            }
            button.elem.prependTo(<span class="hljs-keyword">this</span>.buttons).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                fullscreen.render();
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        _addMovable: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <p>var dragdrop = this.options.dragdrop;
if (dragdrop) {
   dragdrop.add(this.elem, this.header());
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <h2 id="event-loop">Event Loop</h2>

            </div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p> The following classes implement an abstraction on top of the
 javascript event loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> <span class="hljs-built_in">StopIteration</span> = Exception.extend({name: <span class="hljs-string">'StopIteration'</span>});</pre></div></div>
            
        </li>
        
        
        <li id="section-375">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-375">&#182;</a>
              </div>
              <p>The <code>TimeCall</code> is a callback added by the <code>EventLoop</code> to the
javascript event loop engine.
It can be scheduled to a time in the future or executed and the next
frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> TimedCall = Class.extend({
        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(deadline, callback, args)</span> {</span>
            <span class="hljs-keyword">this</span>.deadline = deadline;
            <span class="hljs-keyword">this</span>.cancelled = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.callback = callback;
            <span class="hljs-keyword">this</span>.args = args;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-376">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-376">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        cancel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.cancelled = <span class="hljs-literal">true</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-377">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-377">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        reschedule: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(new_deadline)</span> {</span>
            <span class="hljs-keyword">this</span>._deadline = new_deadline;
            <span class="hljs-keyword">this</span>._cancelled = <span class="hljs-literal">false</span>;
        }
    });

    <span class="hljs-keyword">var</span> LoopingCall = Class.extend({
        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(loop, callback, args, interval)</span> {</span>
            <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>,
                _cancelled = <span class="hljs-literal">false</span>,
                handler;</pre></div></div>
            
        </li>
        
        
        <li id="section-378">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-378">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.callback = callback;
            <span class="hljs-keyword">this</span>.args = args;</pre></div></div>
            
        </li>
        
        
        <li id="section-379">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-379">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> _callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">this</span>.callback.call(<span class="hljs-keyword">this</span>, self.args);
                    } <span class="hljs-keyword">catch</span> (e) {
                        self.cancel();
                        <span class="hljs-keyword">return</span>;
                    }
                    _continue();
                },
                _continue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (!_cancelled) {
                        <span class="hljs-keyword">if</span> (interval) {
                            handler.reschedule(loop.time() + interval);
                            loop.scheduled.insert(handler.deadline, handler);
                        } <span class="hljs-keyword">else</span> {
                            loop.callbacks.append(handler);
                        }
                    }
                };

            <span class="hljs-keyword">if</span> (interval &amp;&amp; interval &gt; <span class="hljs-number">0</span>) {
                interval = interval;
                handler = loop.call_later(interval, _callback);
            } <span class="hljs-keyword">else</span> {
                interval = <span class="hljs-literal">null</span>;
                handler = loop.call_soon(_callback);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-380">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-380">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>            _.extend(<span class="hljs-keyword">this</span>, {
                get cancelled() {
                    <span class="hljs-keyword">return</span> _cancelled;
                },
                cancel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    _cancelled = <span class="hljs-literal">true</span>;
                }
            });
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-381">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-381">&#182;</a>
              </div>
              <p> The <code>EventLoop</code> is a wrapper around the Javascript event loop.
 Useful for combining callbacks and scheduled tasks for a given
 application.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> EventLoop = lux.EventLoop = Class.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-382">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-382">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> _callbacks = [],
                _scheduled = <span class="hljs-keyword">new</span> SkipList(),
                running = <span class="hljs-literal">false</span>,
                nextframe = window.requestAnimationFrame,</pre></div></div>
            
        </li>
        
        
        <li id="section-383">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-383">&#182;</a>
              </div>
              <p>Run at every iteration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _run_once = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(timestamp)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-384">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-384">&#182;</a>
              </div>
              <p>handle scheduled calls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> time = <span class="hljs-keyword">this</span>.time(),
                        callbacks = _callbacks.splice(<span class="hljs-number">0</span>);
                    _(callbacks).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c)</span> {</span>
                        <span class="hljs-keyword">if</span> (!c.cancelled) {
                            c.callback(c.args.splice(<span class="hljs-number">0</span>));
                        }
                    });
                },
                _run = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(timestamp)</span> {</span>
                    <span class="hljs-keyword">if</span> (running) {
                        <span class="hljs-keyword">try</span> {
                            _run_once(timestamp);
                        } <span class="hljs-keyword">catch</span> (e) {
                            <span class="hljs-keyword">if</span> (e.name === <span class="hljs-string">'StopIteration'</span>) {
                                running = <span class="hljs-literal">false</span>;
                                <span class="hljs-keyword">return</span>;
                            }
                        }
                        <span class="hljs-keyword">if</span> (running) {
                            nextframe(_run);
                        }
                    }
                };

            _.extend(<span class="hljs-keyword">this</span>, {
                get callbacks() {
                    <span class="hljs-keyword">return</span> _callbacks;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-385">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-385">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                get scheduled() {
                    <span class="hljs-keyword">return</span> _scheduled;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-386">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-386">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                call_soon: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                    <span class="hljs-keyword">var</span> call = <span class="hljs-keyword">new</span> TimedCall(<span class="hljs-literal">null</span>, callback, slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
                    _callbacks.append(call);
                    <span class="hljs-keyword">return</span> call;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-387">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-387">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                call_later: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(milliseconds, callback)</span> {</span>
                    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>),
                        call = <span class="hljs-keyword">new</span> TimedCall(<span class="hljs-keyword">this</span>.time() + milliseconds, callback, args);
                    _scheduled.insert(call.deadline, call);
                    <span class="hljs-keyword">return</span> call;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-388">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-388">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                call_at: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(when, callback)</span> {</span>
                    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>),
                        call = <span class="hljs-keyword">new</span> TimedCall(when, callback, args);
                    _scheduled.insert(call.deadline, call);
                    <span class="hljs-keyword">return</span> call;
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-389">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-389">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                run: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (!running) {
                        running = <span class="hljs-literal">true</span>;
                        nextframe(_run);
                    }
                },</pre></div></div>
            
        </li>
        
        
        <li id="section-390">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-390">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>                is_running: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">return</span> running;
                }
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-391">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-391">&#182;</a>
              </div>
              <p>Schedule a <code>callback</code> to be executed at every frame of the
event loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        call_every: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LoopingCall(<span class="hljs-keyword">this</span>, callback, slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-392">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-392">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        time: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-393">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-393">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        stop: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.is_running()) {
                <span class="hljs-keyword">this</span>.call_soon(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (callback) {
                        <span class="hljs-keyword">try</span> {
                            callback();
                        } <span class="hljs-keyword">catch</span> (e) {
                            console.log(e);
                        }
                    }
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">StopIteration</span>();
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (callback) {
                callback();
            }
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-394">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-394">&#182;</a>
              </div>
              <p>Default event loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lux.eventloop = <span class="hljs-keyword">new</span> EventLoop();

    <span class="hljs-keyword">var</span> each = lux.each;</pre></div></div>
            
        </li>
        
        
        <li id="section-395">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-395">&#182;</a>
              </div>
              <h2 id="-lux-utils"> Lux Utils</h2>

            </div>
            
        </li>
        
        
        <li id="section-396">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-396">&#182;</a>
              </div>
              <p>Stand alone functions used throughout the lux web libraries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    lux.utils = {</pre></div></div>
            
        </li>
        
        
        <li id="section-397">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-397">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        detector: {
            canvas: !! window.CanvasRenderingContext2D,
            <span class="hljs-comment">/*
            webgl: (function () {
                try {
                    return !! window.WebGLRenderingContext &amp;&amp; !! document.createElement('canvas').getContext('experimental-webgl');
                } catch( e ) {
                    return false;
                }
            }()),
            */</span>
            workers: !! window.Worker,
            fileapi: window.File &amp;&amp; window.FileReader &amp;&amp; window.FileList &amp;&amp; window.Blob
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-398">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-398">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        allClasses: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
            <span class="hljs-keyword">var</span> classes = {}, all = [];
            $(elem).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.className) {
                    $.each(<span class="hljs-keyword">this</span>.className.split(<span class="hljs-string">' '</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>;
                        <span class="hljs-keyword">if</span> (name !== <span class="hljs-string">''</span> &amp;&amp; classes[name] === <span class="hljs-literal">undefined</span>) {
                            classes[name] = name;
                            all.push(name);
                        }
                    });
                }
            });
            <span class="hljs-keyword">return</span> all;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-399">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-399">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        as_tag: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tag, elem)</span> {</span>
            <span class="hljs-keyword">var</span> o = $(elem);
            <span class="hljs-keyword">if</span> (!o.length &amp;&amp; <span class="hljs-keyword">typeof</span> elem === <span class="hljs-string">"string"</span>) {
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">'&lt;'</span>+tag+<span class="hljs-string">'&gt;'</span>).html(elem);
            }
            <span class="hljs-keyword">if</span> (o.length) {
                <span class="hljs-keyword">if</span> (!o.is(tag)) {
                    o = $(<span class="hljs-string">'&lt;'</span>+tag+<span class="hljs-string">'&gt;'</span>).append(o);
                }
                <span class="hljs-keyword">return</span> o;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-400">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-400">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        closest_color: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el, property)</span> {</span>
            <span class="hljs-keyword">var</span> val = <span class="hljs-literal">null</span>;
            el = $(el);
            <span class="hljs-keyword">while</span> (el.length &amp;&amp; val === <span class="hljs-literal">null</span>) {
                el = el.parent();
                val = el.css(property);
                <span class="hljs-keyword">if</span> (val == <span class="hljs-string">'inherit'</span> || val == <span class="hljs-string">'transparent'</span>) {
                    val = <span class="hljs-literal">null</span>;
                }
            }
            <span class="hljs-keyword">return</span> val;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-401">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-401">&#182;</a>
              </div>
              <p>Return a valid url from an array of strings. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        urljoin: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> normalize = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(str)</span> {</span>
                    <span class="hljs-keyword">return</span> str
                        .replace(<span class="hljs-regexp">/[\/]+/g</span>, <span class="hljs-string">'/'</span>)
                        .replace(<span class="hljs-regexp">/\/\?/g</span>, <span class="hljs-string">'?'</span>)
                        .replace(<span class="hljs-regexp">/\/\#/g</span>, <span class="hljs-string">'#'</span>)
                        .replace(<span class="hljs-regexp">/\:\//g</span>, <span class="hljs-string">'://'</span>);
                },
                joined = [].slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>).join(<span class="hljs-string">'/'</span>);
            <span class="hljs-keyword">return</span> normalize(joined);  
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-402">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-402">&#182;</a>
              </div>
              <p>Return a uman redable string describing the time <code>diff</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        prettyTime: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(diff)</span> {</span>
            <span class="hljs-keyword">var</span> day_diff = <span class="hljs-built_in">Math</span>.floor(diff / <span class="hljs-number">86400</span>);
            <span class="hljs-keyword">return</span> day_diff === <span class="hljs-number">0</span> &amp;&amp; (
                        diff &lt; <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-string">"1 second ago"</span> ||
                        diff &lt; <span class="hljs-number">60</span> &amp;&amp; <span class="hljs-built_in">Math</span>.floor( diff ) + <span class="hljs-string">" seconds ago"</span> ||
                        diff &lt; <span class="hljs-number">120</span> &amp;&amp; <span class="hljs-string">"1 minute ago"</span> ||
                        diff &lt; <span class="hljs-number">3600</span> &amp;&amp; <span class="hljs-built_in">Math</span>.floor( diff / <span class="hljs-number">60</span> ) + <span class="hljs-string">" minutes ago"</span> ||
                        diff &lt; <span class="hljs-number">7200</span> &amp;&amp; <span class="hljs-string">"1 hour ago"</span> ||
                        diff &lt; <span class="hljs-number">86400</span> &amp;&amp; <span class="hljs-built_in">Math</span>.floor( diff / <span class="hljs-number">3600</span> ) + <span class="hljs-string">" hours ago"</span>) ||
                    day_diff === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-string">"Yesterday"</span> ||
                    day_diff &lt; <span class="hljs-number">7</span> &amp;&amp; day_diff + <span class="hljs-string">" days ago"</span> ||
                    day_diff &lt; <span class="hljs-number">31</span> &amp;&amp; <span class="hljs-built_in">Math</span>.ceil( day_diff / <span class="hljs-number">7</span> ) + <span class="hljs-string">" weeks ago"</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-403">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-403">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        asDate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
                <span class="hljs-keyword">return</span> value;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> d = <span class="hljs-built_in">parseFloat</span>(value);
                <span class="hljs-keyword">if</span> (d === d) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-number">1000</span>*d);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Could not convert '</span> + value + <span class="hljs-string">' to a date'</span>);
                }
            }
        }
    };
<span class="hljs-keyword">var</span> math = {},
    PI = <span class="hljs-built_in">Math</span>.PI;</pre></div></div>
            
        </li>
        
        
        <li id="section-404">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-404">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>lux.math = math;</pre></div></div>
            
        </li>
        
        
        <li id="section-405">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-405">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>$.extend(math, {
    point2d: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'x'</span>: x, <span class="hljs-string">'y'</span>: y};
    },
    distance2d: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(p1, p2)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.sqrt(((p1.x - p2.x) * (p1.x - p2.x)) +
                         ((p1.y - p2.y) * (p1.y - p2.y)));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-406">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-406">&#182;</a>
              </div>
              <p>angle (in radians) between 3 points
       x3,y3
      /
  x2,y2
      \
      x1,y1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    angle2d: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x1, y1, x2, y2, x3, y3)</span> {</span>
        <span class="hljs-keyword">var</span> xx1 = x1-x2,
            yy1 = y1-y2,
            xx2 = x3-x2,
            yy2 = y3-y2,
            a1 = <span class="hljs-built_in">Math</span>.atan2(xx1, yy1),
            a2 = <span class="hljs-built_in">Math</span>.atan2(xx2, yy2);
        <span class="hljs-keyword">return</span> a1 - a2;
    },
    degree: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(rad)</span> {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">180</span> * rad / PI;
    },
    radians: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(deg)</span> {</span>
        <span class="hljs-keyword">return</span> PI * deg / <span class="hljs-number">180</span>;
    }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-407">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-407">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> random = <span class="hljs-built_in">Math</span>.random,
    log = <span class="hljs-built_in">Math</span>.log,
    NV_MAGICCONST = <span class="hljs-number">4</span> * <span class="hljs-built_in">Math</span>.exp(-<span class="hljs-number">0.5</span>)/<span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-number">2.0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-408">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-408">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>$.extend(math, {</pre></div></div>
            
        </li>
        
        
        <li id="section-409">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-409">&#182;</a>
              </div>
              <p>Normal variates using the ratio of uniform deviates algorithm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    normalvariate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(mu, sigma)</span> {</span>
        <span class="hljs-keyword">var</span> u1, u2, z, zz; 
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            u1 = random();
            u2 = <span class="hljs-number">1.0</span> - random();
            z = NV_MAGICCONST*(u1-<span class="hljs-number">0.5</span>)/u2;
            zz = z*z/<span class="hljs-number">4.0</span>;
            <span class="hljs-keyword">if</span> (zz &lt;= -log(u2)) {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> mu + z*sigma;
    }
});
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    <span class="hljs-keyword">var</span> isCommonjs = <span class="hljs-keyword">typeof</span> module !== <span class="hljs-string">'undefined'</span> &amp;&amp; module.exports;
    <span class="hljs-keyword">var</span> keyboardAllowed = <span class="hljs-keyword">typeof</span> Element !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-string">'ALLOW_KEYBOARD_INPUT'</span> <span class="hljs-keyword">in</span> Element;

    <span class="hljs-keyword">var</span> fn = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> val;
        <span class="hljs-keyword">var</span> valLength;

        <span class="hljs-keyword">var</span> fnMap = [
            [
                <span class="hljs-string">'requestFullscreen'</span>,
                <span class="hljs-string">'exitFullscreen'</span>,
                <span class="hljs-string">'fullscreenElement'</span>,
                <span class="hljs-string">'fullscreenEnabled'</span>,
                <span class="hljs-string">'fullscreenchange'</span>,
                <span class="hljs-string">'fullscreenerror'</span>
            ],</pre></div></div>
            
        </li>
        
        
        <li id="section-410">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-410">&#182;</a>
              </div>
              <p>new WebKit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [
                <span class="hljs-string">'webkitRequestFullscreen'</span>,
                <span class="hljs-string">'webkitExitFullscreen'</span>,
                <span class="hljs-string">'webkitFullscreenElement'</span>,
                <span class="hljs-string">'webkitFullscreenEnabled'</span>,
                <span class="hljs-string">'webkitfullscreenchange'</span>,
                <span class="hljs-string">'webkitfullscreenerror'</span>

            ],</pre></div></div>
            
        </li>
        
        
        <li id="section-411">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-411">&#182;</a>
              </div>
              <p>old WebKit (Safari 5.1)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [
                <span class="hljs-string">'webkitRequestFullScreen'</span>,
                <span class="hljs-string">'webkitCancelFullScreen'</span>,
                <span class="hljs-string">'webkitCurrentFullScreenElement'</span>,
                <span class="hljs-string">'webkitCancelFullScreen'</span>,
                <span class="hljs-string">'webkitfullscreenchange'</span>,
                <span class="hljs-string">'webkitfullscreenerror'</span>

            ],
            [
                <span class="hljs-string">'mozRequestFullScreen'</span>,
                <span class="hljs-string">'mozCancelFullScreen'</span>,
                <span class="hljs-string">'mozFullScreenElement'</span>,
                <span class="hljs-string">'mozFullScreenEnabled'</span>,
                <span class="hljs-string">'mozfullscreenchange'</span>,
                <span class="hljs-string">'mozfullscreenerror'</span>
            ],
            [
                <span class="hljs-string">'msRequestFullscreen'</span>,
                <span class="hljs-string">'msExitFullscreen'</span>,
                <span class="hljs-string">'msFullscreenElement'</span>,
                <span class="hljs-string">'msFullscreenEnabled'</span>,
                <span class="hljs-string">'MSFullscreenChange'</span>,
                <span class="hljs-string">'MSFullscreenError'</span>
            ]
        ];

        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> l = fnMap.length;
        <span class="hljs-keyword">var</span> ret = {};

        <span class="hljs-keyword">for</span> (; i &lt; l; i++) {
            val = fnMap[i];
            <span class="hljs-keyword">if</span> (val &amp;&amp; val[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> document) {
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, valLength = val.length; i &lt; valLength; i++) {
                    ret[fnMap[<span class="hljs-number">0</span>][i]] = val[i];
                }
                <span class="hljs-keyword">return</span> ret;
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    })();

    <span class="hljs-keyword">var</span> screenfull = {
        request: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
            <span class="hljs-keyword">var</span> request = fn.requestFullscreen;

            elem = elem || document.documentElement;</pre></div></div>
            
        </li>
        
        
        <li id="section-412">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-412">&#182;</a>
              </div>
              <p>Work around Safari 5.1 bug: reports support for
keyboard in fullscreen even though it doesn’t.
Browser sniffing, since the alternative with
setTimeout is even worse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/5\.1[\.\d]* Safari/</span>.test(navigator.userAgent)) {
                elem[request]();
            } <span class="hljs-keyword">else</span> {
                elem[request](keyboardAllowed &amp;&amp; Element.ALLOW_KEYBOARD_INPUT);
            }
        },
        exit: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            document[fn.exitFullscreen]();
        },
        toggle: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(elem)</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFullscreen) {
                <span class="hljs-keyword">this</span>.exit();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.request(elem);
            }
        },
        onchange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>},
        onerror: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>},
        raw: fn
    };

    <span class="hljs-keyword">if</span> (!fn) {
        <span class="hljs-keyword">if</span> (isCommonjs) {
            module.exports = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
            window.screenfull = <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-built_in">Object</span>.defineProperties(screenfull, {
        isFullscreen: {
            get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">return</span> !!document[fn.fullscreenElement];
            }
        },
        element: {
            enumerable: <span class="hljs-literal">true</span>,
            get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">return</span> document[fn.fullscreenElement];
            }
        },
        enabled: {
            enumerable: <span class="hljs-literal">true</span>,
            get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-413">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-413">&#182;</a>
              </div>
              <p>Coerce to boolean in case of old WebKit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> !!document[fn.fullscreenEnabled];
            }
        }
    });

    document.addEventListener(fn.fullscreenchange, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
        screenfull.onchange.call(screenfull, e);
    });

    document.addEventListener(fn.fullscreenerror, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
        screenfull.onerror.call(screenfull, e);
    });

    <span class="hljs-keyword">if</span> (isCommonjs) {
        module.exports = screenfull;
    } <span class="hljs-keyword">else</span> {
        window.screenfull = screenfull;
    }
})();

	<span class="hljs-keyword">return</span> _.extend(lux, prev_lux);
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
