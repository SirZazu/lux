<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lux.extensions.api &mdash; lux 0.1a2 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/pulsar.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1a2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="lux 0.1a2 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">lux 0.1a2 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
<div class="deck">
<div class="header">
    
        <p class="developmentversion">
        Documentation for lux's <strong>DEVELOPMENT</strong> version. Get the
        <a href="http://pythonhosted.org/lux/">release docs here</a>.
        </p>
    
</div>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for lux.extensions.api</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;A :ref:`lux extension &lt;extensions&gt;` for managing data models and</span>
<span class="sd">RESTful web API.</span>
<span class="sd">To use it, simply add it to the list of :ref:`EXTENSIONS &lt;config-extensions&gt;`</span>
<span class="sd">of your application::</span>

<span class="sd">    EXTENSIONS = [...,</span>
<span class="sd">                  &#39;lux.extensions.api&#39;,</span>
<span class="sd">                  ...]</span>

<span class="sd">:setting:`DATASTORE` is the most important :class:`.Parameter` of</span>
<span class="sd">this extension. It defines a dictionary for mapping</span>
<span class="sd">models to backend data-stores.</span>

<span class="sd">If :setting:`API_URL` is defined, the extension include a middleware for</span>
<span class="sd">serving the restful api url. The middleware collects :class:`.Crud` routers</span>
<span class="sd">from all extensions which provides the ``api_sections`` method.</span>

<span class="sd">Parameters</span>
<span class="sd">================</span>

<span class="sd">.. lux_extension:: lux.extensions.api</span>

<span class="sd">Usage</span>
<span class="sd">================</span>

<span class="sd">The base url for the web API is defined by the :setting:`API_URL` setting.</span>

<span class="sd">Adding Handlers</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">To add API handlers for a model, or group of models, one starts by creating</span>
<span class="sd">a new :ref:`lux Extension &lt;extensions&gt;` and implement the :meth:`api_sections`</span>
<span class="sd">method::</span>

<span class="sd">    import lux</span>
<span class="sd">    from lux.extensions.api import Crud</span>

<span class="sd">    class BlogExtension(lux.Extension):</span>

<span class="sd">        def api_sections(self, app):</span>
<span class="sd">            yield &#39;Blog&#39;, [Crud(&#39;blog&#39;, Blog)]</span>

<span class="sd">The ``api_sections`` method returns an iterable over two-elements tuples.</span>
<span class="sd">The first element in the tuple is a string representing the name of a Section</span>
<span class="sd">in the ``Api`` documentation. The second element is an iterable</span>
<span class="sd">over :class:`Crud` routers which handles requests.</span>
<span class="sd">The Routers will be appended to the :class:`Api` Router.</span>

<span class="sd">The example above adds one single :class:`.Crud` router to the :class:`Api`</span>
<span class="sd">router. The router serves requests at the ``/api/blog/`` url.</span>


<span class="sd">Object Data Mapper</span>
<span class="sd">======================</span>

<span class="sd">The object data mapper must provide the following:</span>

<span class="sd">* ``Mapper`` class for managing models</span>
<span class="sd">* ``search_engine`` to create a full text search engine handler</span>

<span class="sd">The mapper object must expose the following methods:</span>

<span class="sd">* ``register_applications``</span>


<span class="sd">API</span>
<span class="sd">=====</span>

<span class="sd">API Extension</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: Extension</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">API Router</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: Api</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _crud-content-manager:</span>

<span class="sd">.. module:: lux.extensions.api.content</span>

<span class="sd">CRUD ContentManager</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: ContentManager</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _crud-router:</span>

<span class="sd">.. module:: lux.extensions.api.crud</span>

<span class="sd">CRUD Router</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: Crud</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>


<span class="sd">.. _crud-websocket:</span>

<span class="sd">.. module:: lux.extensions.api.websocket</span>

<span class="sd">CRUD Websocket</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">.. autoclass:: CrudWebSocket</span>
<span class="sd">   :members:</span>
<span class="sd">   :member-order: bysource</span>

<span class="sd">.. _crud-message:</span>

<span class="sd">CRUD message</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">pulsar</span> <span class="kn">import</span> <span class="n">HttpException</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.structures</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">mapping_iterator</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.pep</span> <span class="kn">import</span> <span class="n">itervalues</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.html</span> <span class="kn">import</span> <span class="n">slugify</span>
<span class="kn">from</span> <span class="nn">pulsar.apps.wsgi</span> <span class="kn">import</span> <span class="n">Json</span>
<span class="kn">from</span> <span class="nn">pulsar.utils.httpurl</span> <span class="kn">import</span> <span class="n">JSON_CONTENT_TYPES</span><span class="p">,</span> <span class="n">remove_double_slash</span>
<span class="kn">from</span> <span class="nn">pulsar.apps.data</span> <span class="kn">import</span> <span class="n">DEFAULT_PULSAR_STORE_ADDRESS</span>

<span class="kn">import</span> <span class="nn">lux</span>
<span class="kn">from</span> <span class="nn">lux</span> <span class="kn">import</span> <span class="n">Router</span><span class="p">,</span> <span class="n">Parameter</span>

<span class="kn">from</span> <span class="nn">.crud</span> <span class="kn">import</span> <span class="n">Crud</span>
<span class="kn">from</span> <span class="nn">.content</span> <span class="kn">import</span> <span class="n">ContentManager</span>
<span class="kn">from</span> <span class="nn">.websocket</span> <span class="kn">import</span> <span class="n">CrudWebSocket</span>
<span class="kn">from</span> <span class="nn">.admin</span> <span class="kn">import</span> <span class="n">Admin</span>


<span class="n">DEFAULT_ADDRESS</span> <span class="o">=</span> <span class="s">&#39;pulsar://</span><span class="si">%s</span><span class="s">/3&#39;</span> <span class="o">%</span> <span class="n">DEFAULT_PULSAR_STORE_ADDRESS</span>


<div class="viewcode-block" id="Api"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Api">[docs]</a><span class="k">class</span> <span class="nc">Api</span><span class="p">(</span><span class="n">lux</span><span class="o">.</span><span class="n">Router</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;:ref:`Router &lt;router&gt;` to use as root for all api routers.&#39;&#39;&#39;</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">response_content_types</span> <span class="o">=</span> <span class="n">lux</span><span class="o">.</span><span class="n">RouterParam</span><span class="p">(</span><span class="n">JSON_CONTENT_TYPES</span><span class="p">)</span>

<div class="viewcode-block" id="Api.get"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Api.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get all routes grouped in sections.</span>

<span class="sd">        This is the only method available for the router base route.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="n">JSON_CONTENT_TYPES</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">Json</span><span class="p">(</span><span class="n">as_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">mapping_iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">):</span>
                <span class="n">json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(((</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;routes&#39;</span><span class="p">,</span> <span class="n">section</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="n">request</span><span class="p">)))))</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">http_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HttpException</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">415</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">ApiSection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">router</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">router</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routers</span><span class="p">:</span>
            <span class="nb">all</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">router</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">router</span><span class="o">.</span><span class="n">path</span><span class="p">()))</span>
        <span class="k">return</span> <span class="nb">all</span>

    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">router</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routers</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="nb">all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(((</span><span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="n">router</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s">&#39;api_url&#39;</span><span class="p">,</span> <span class="n">router</span><span class="o">.</span><span class="n">path</span><span class="p">()),</span>
                                    <span class="p">(</span><span class="s">&#39;fields&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">))))</span>
        <span class="k">return</span> <span class="nb">all</span>


<div class="viewcode-block" id="Extension"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension">[docs]</a><span class="k">class</span> <span class="nc">Extension</span><span class="p">(</span><span class="n">lux</span><span class="o">.</span><span class="n">Extension</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A RESTful API :ref:`lux extension`.</span>

<span class="sd">    .. attribute:: html_crud_routers</span>

<span class="sd">        Dictionary of Routers serving a models for Html requests</span>

<span class="sd">    .. attribute:: api_crud_routers</span>

<span class="sd">        Dictionary of Routers serving a model for Api requests</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_config</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;DATASTORE&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s">&#39;Dictionary for mapping models to their back-ends database&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;SEARCHENGINE&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s">&#39;Search engine for models&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;ODM&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s">&#39;Object Data Mapper. Must provide the Mapper class.&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;DUMPDB_EXTENSIONS&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;API_URL&#39;</span><span class="p">,</span> <span class="s">&#39;api&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;ADMIN_URL&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="s">&#39;Optional admin url for HTML views of models&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;ADMIN_TEMPLATE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="s">&#39;Optional template class for the admin site&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;API_DOCS_URL&#39;</span><span class="p">,</span> <span class="s">&#39;api/docs&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;QUERY_MAX_LENGTH&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="s">&#39;Maximum number of elements per query&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;QUERY_FIELD_KEY&#39;</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span>
                  <span class="s">&#39;The query key to retrieve specific fields of a model&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;QUERY_SEARCH_KEY&#39;</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span>
                  <span class="s">&#39;The query key for full text search&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;QUERY_START_KEY&#39;</span><span class="p">,</span> <span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
        <span class="n">Parameter</span><span class="p">(</span><span class="s">&#39;QUERY_LENGTH_KEY&#39;</span><span class="p">,</span> <span class="s">&#39;per_page&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)]</span>
    <span class="n">html_crud_routers</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">api_crud_routers</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Extension.middleware"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension.middleware">[docs]</a>    <span class="k">def</span> <span class="nf">middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Build the API middleware.</span>

<span class="sd">        If :setting:`API_URL` is defined, it loops through all extensions</span>
<span class="sd">        and checks if the ``api_sections`` method is available.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">middleware</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;API_URL&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;API_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span> <span class="o">=</span> <span class="n">remove_double_slash</span><span class="p">(</span><span class="s">&#39;/</span><span class="si">%s</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="n">sections</span><span class="p">)</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;API_DOCS_URL&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;API_DOCS_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span> <span class="o">=</span> <span class="n">remove_double_slash</span><span class="p">(</span><span class="s">&#39;/</span><span class="si">%s</span><span class="s">/&#39;</span>
                                                                       <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">docs</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="n">sections</span><span class="p">)</span>
                <span class="n">middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">)</span>
            <span class="c">#</span>
            <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">extensions</span><span class="p">):</span>
                <span class="n">api_sections</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="s">&#39;api_sections&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">api_sections</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">routers</span> <span class="ow">in</span> <span class="n">api_sections</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
                        <span class="c"># Routes must be instances of CRUD</span>
                        <span class="c"># name is the section name</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                            <span class="n">sections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ApiSection</span><span class="p">()</span>
                        <span class="n">section</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">router</span> <span class="ow">in</span> <span class="n">routers</span><span class="p">:</span>
                            <span class="n">api</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>
                            <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>
                            <span class="n">manager</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">manager</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">api_crud_routers</span><span class="p">[</span><span class="n">manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ADMIN_URL&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ADMIN_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span> <span class="o">=</span> <span class="n">remove_double_slash</span><span class="p">(</span><span class="s">&#39;/</span><span class="si">%s</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="n">sections</span><span class="p">)</span>
            <span class="n">middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
            <span class="c">#for extension in itervalues(app.extensions):</span>
            <span class="c">#    api_sections = getattr(extension, &#39;api_sections&#39;, None)</span>
            <span class="c">#    if api_sections:</span>
            <span class="c">#        pass</span>
        <span class="k">return</span> <span class="n">middleware</span>
</div>
<div class="viewcode-block" id="Extension.on_config"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension.on_config">[docs]</a>    <span class="k">def</span> <span class="nf">on_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a pulsar mapper with all models registered.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">app</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_mapper</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">on_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">router</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">middleware</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_html_router</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>

<div class="viewcode-block" id="Extension.on_html_document"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension.on_html_document">[docs]</a>    <span class="k">def</span> <span class="nf">on_html_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;When the document is created add stylesheet and default</span>
<span class="sd">        scripts to the document media.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span>
        <span class="n">html</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s">&#39;api&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;search&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;QUERY_SEARCH_KEY&#39;</span><span class="p">],</span>
                          <span class="s">&#39;start&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;QUERY_START_KEY&#39;</span><span class="p">],</span>
                          <span class="s">&#39;per_page&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;QUERY_LENGTH_KEY&#39;</span><span class="p">]})</span>

    <span class="c">#    INTERNALS</span></div>
    <span class="k">def</span> <span class="nf">_create_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="c"># Create the object data mapper</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span>
        <span class="n">odm</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;ODM&#39;</span><span class="p">]</span>
        <span class="n">default_address</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">odm</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pulsar.apps.data</span> <span class="kn">import</span> <span class="n">odm</span>
            <span class="n">config</span><span class="p">[</span><span class="s">&#39;ODM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odm</span>
            <span class="n">default_address</span> <span class="o">=</span> <span class="n">DEFAULT_ADDRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">html_crud_routers</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">ModelDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_crud_routers</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">ModelDictionary</span><span class="p">()</span>
        <span class="n">datastore</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;DATASTORE&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default_address</span><span class="p">:</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">default_address</span>
                <span class="n">config</span><span class="p">[</span><span class="s">&#39;DATASTORE&#39;</span><span class="p">][</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Default datastore not set&#39;</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">Mapper</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_search_engine</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">mapper</span><span class="p">)</span>
        <span class="c"># don&#39;t need lux has we know it does not have any model</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">&#39;EXTENSIONS&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">register_applications</span><span class="p">(</span><span class="n">extensions</span><span class="p">,</span> <span class="n">stores</span><span class="o">=</span><span class="n">datastore</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapper</span>

<div class="viewcode-block" id="Extension.add_to_html_router"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension.add_to_html_router">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_html_router</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">router</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add ``router`` to the :attr:`html_crud_routers` dictionary if</span>
<span class="sd">        the default content type is ``text/html`` and the router model is not</span>
<span class="sd">        already available.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">Crud</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">default_content_type</span> <span class="o">==</span> <span class="s">&#39;text/html&#39;</span>
                    <span class="ow">and</span> <span class="n">router</span><span class="o">.</span><span class="n">manager</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">html_crud_routers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">html_crud_routers</span><span class="p">[</span><span class="n">router</span><span class="o">.</span><span class="n">manager</span><span class="p">]</span> <span class="o">=</span> <span class="n">router</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">router</span><span class="p">,</span> <span class="n">Router</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">router</span> <span class="ow">in</span> <span class="n">router</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_to_html_router</span><span class="p">(</span><span class="n">router</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">manager_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">router</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">router</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

<div class="viewcode-block" id="Extension.set_search_engine"><a class="viewcode-back" href="../../../extensions/api.html#lux.extensions.api.Extension.set_search_engine">[docs]</a>    <span class="k">def</span> <span class="nf">set_search_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set the full-text search engine.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SEARCHENGINE&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DATASTORE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">odm</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ODM&#39;</span><span class="p">]</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">odm</span><span class="o">.</span><span class="n">search_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">set_search_engine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="../../../index.html">
  <img class="logo" width="200" src="../../../_static/lux.jpg" alt="lux" title="lux"/>
</a>
</p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
        &copy; Copyright 2011-2013, Luca Sbardella.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  
  _gaq.push(['_setAccount', 'UA-3900561-8']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>